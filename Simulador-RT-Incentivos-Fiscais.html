<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador da Reforma Tributária - IVA Dual (CBS/IBS)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Função auxiliar para formatação de números no padrão brasileiro
        function formatarBR(valor, decimais = 2) {
            // Trata valores indefinidos ou NaN
            if (valor === undefined || valor === null || isNaN(valor)) {
                valor = 0;
            }
            
            // Se não for um número, tenta converter
            if (typeof valor !== 'number') {
                valor = parseFloat(valor) || 0;
            }
            
            return valor.toLocaleString('pt-BR', {
                minimumFractionDigits: decimais,
                maximumFractionDigits: decimais
            });
        }
        // 1. Adicione esta função no início da seção de script, antes de qualquer uso dela:
        function obterValorNumerico(campo) {
            if (!campo) return 0;
            
            // Se já for uma string, assume que é o valor
            if (typeof campo === 'string') {
                let valor = campo;
                // Remove a máscara monetária (R$, pontos e espaços)
                valor = valor.replace(/[R$\s.]/g, '');
                // Substitui vírgula por ponto (formato decimal)
                valor = valor.replace(',', '.');
                // Converte para número
                const resultado = parseFloat(valor);
                // Se não for um número válido, retorna 0
                return isNaN(resultado) ? 0 : resultado;
            }
            
            // Se for um elemento DOM
            if (campo.value !== undefined) {
                let valor = campo.value;
                // Se estiver vazio ou com valor inicial
                if (valor === '' || valor === 'R$ 0,00') return 0;
                // Remove a máscara monetária (R$, pontos e espaços)
                valor = valor.replace(/[R$\s.]/g, '');
                // Substitui vírgula por ponto (formato decimal)
                valor = valor.replace(',', '.');
                // Converte para número
                const resultado = parseFloat(valor);
                // Se não for um número válido, retorna 0
                return isNaN(resultado) ? 0 : resultado;
            }
            
            return 0;
        }
        // Adicione a nova função aqui:
        function solicitarNomeArquivo(extensao, nomeDefault) {
            let nomeArquivo = prompt(
                `Digite o nome do arquivo para salvar (sem a extensão .${extensao}):`, 
                nomeDefault || `relatorio-${new Date().toISOString().slice(0, 10)}`
            );
            
            if (nomeArquivo === null) {
                return null;
            }
            
            nomeArquivo = nomeArquivo.replace(/[<>:"/\\|?*]/g, '-');
            
            if (!nomeArquivo.trim()) {
                nomeArquivo = nomeDefault || `relatorio-${new Date().toISOString().slice(0, 10)}`;
            }
            
            return `${nomeArquivo}.${extensao}`;
        }
    </script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --accent-color: #e74c3c;
            --dark-accent: #f39c12;
            --highlight-color: #9b59b6;
            --light-bg: #f8f9fa;
            --dark-text: #343a40;
            --gray-text: #6c757d;
            --light-border: #dee2e6;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light-bg);
            color: var(--dark-text);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 20px;
        }

        .tab-container {
            width: 100%;
        }

        .tab-buttons {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--light-border);
        }

        .tab-button {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-text);
            transition: all 0.3s;
        }

        .tab-button.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }

        .panel {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark-text);
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--light-border);
            border-radius: 4px;
            font-size: 14px;
        }

        input[type="number"] {
            text-align: right;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #2980b9;
        }

        .group-box {
            border: 1px solid var(--light-border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .group-box h3 {
            margin-top: 0;
            color: var(--dark-text);
            font-size: 16px;
            margin-bottom: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        table th, table td {
            border: 1px solid var(--light-border);
            padding: 8px;
            text-align: left;
        }

        table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        .chart-container {
            height: 300px;
            margin-bottom: 20px;
        }

        .incentivos-tab-container {
            margin-bottom: 20px;
        }

        .incentivos-tab-buttons {
            display: flex;
            border-bottom: 1px solid var(--light-border);
        }

        .incentivos-tab-button {
            padding: 8px 15px;
            font-size: 14px;
            background: #f5f5f5; /* Fundo claro para botões inativos */
            border: 1px solid var(--light-border);
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            margin-right: 4px;
            color: var(--gray-text); /* Cor menos contrastante para texto inativo */
            transition: all 0.3s ease;
        }

        .incentivos-tab-button.active {
            color: var(--primary-color);
            background: white;
            border-bottom: 2px solid var(--primary-color);
            font-weight: 600;
        }

        .incentivos-tab-button:hover:not(.active) {
            background: #e9e9e9;
            color: var(--dark-text);
        }

        .incentivos-tab-content {
            display: none;
            padding: 10px 0;
        }

        .incentivos-tab-content.active {
            display: block;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .result-value {
            color: var(--primary-color);
            font-weight: bold;
        }

        .positive-value {
            color: var(--secondary-color);
        }

        .negative-value {
            color: var(--accent-color);
        }

        .footer {
            margin-top: 20px;
            text-align: center;
            font-size: 12px;
            color: var(--gray-text);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            width: 400px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            cursor: pointer;
            font-size: 24px;
            font-weight: bold;
        }

        .help-section {
            margin-bottom: 20px;
        }

        .help-section h3 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .help-section ul, .help-section ol {
            padding-left: 20px;
        }

        .help-section li {
            margin-bottom: 10px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        #memoria-calculo {
            font-family: monospace;
            white-space: pre-wrap;
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            height: 500px;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .logo {
            height: 60px; /* ajuste conforme o tamanho do seu logo */
            margin-right: 20px;
        }
    </style>>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="imagens/expertzy-it.png" alt="Expertzy Inteligência Tributária" class="logo">
            <h1>Simulador da Reforma Tributária - IVA Dual (CBS/IBS)</h1>
        </div>    
        
        <div class="tab-container">
            <div class="tab-buttons">
                <button class="tab-button active" data-tab="simulacao">Simulação</button>
                <button class="tab-button" data-tab="configuracoes">Configurações</button>
                <button class="tab-button" data-tab="memoria">Memória de Cálculo</button>
                <button class="tab-button" data-tab="ajuda">Ajuda e Documentação</button>
            </div>
            
            <!-- Simulação Tab -->
            <div id="simulacao" class="tab-content active">
                <div class="grid">
                    <!-- Painel de entrada -->
                    <div class="panel">
                        <div class="group-box">
                            <h3>Dados da Empresa</h3>
                            <div class="form-group">
                                <label for="faturamento">Faturamento Anual:</label>
                                <input type="text" id="faturamento" value="0">
                            </div>
                            <div class="form-group">
                                <label for="custos">Custos Tributáveis (PIS/COFINS/IVA/CBS):</label>
                                <input type="text" id="custos" value="0" title="Custos que geram crédito para PIS/COFINS e futuramente para IVA/CBS">
                            </div>
                            <div class="form-group">
                                <label for="custos_icms">Custos Tributáveis - ICMS:</label>
                                <input type="text" id="custos_icms" value="0" title="Custos que geram crédito específico para ICMS">
                            </div>
                            <div class="form-group">
                                <label for="custos_simples">Custos de Fornecedores do Simples:</label>
                                <input type="text" id="custos_simples" value="0">
                            </div>
                            <div class="form-group">
                                <label for="creditos_anteriores">Créditos Anteriores:</label>
                                <input type="text" id="creditos_anteriores" value="0">
                            </div>
                            <div class="form-group">
                                <label for="setor">Setor de Atividade:</label>
                                <select id="setor">
                                    <option value="padrao">Padrão</option>
                                    <option value="educacao">Educação</option>
                                    <option value="saude">Saúde</option>
                                    <option value="alimentos">Alimentos</option>
                                    <option value="transporte">Transporte</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="regime">Regime Tributário:</label>
                                <select id="regime">
                                    <option value="real">Lucro Real</option>
                                    <option value="presumido">Lucro Presumido</option>
                                    <option value="simples">Simples Nacional</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="carga_atual">Carga Tributária Atual (%):</label>
                                <input type="number" id="carga_atual" value="25" step="0.1" min="0" max="100">
                            </div>
                        </div>

                        <div class="group-box">
                            <h3>Parâmetros de ICMS e Incentivos Fiscais</h3>
                            <div class="form-group">
                                <label for="aliquota_entrada">Alíquota Média de Entrada:</label>
                                <input type="number" id="aliquota_entrada" value="19" step="0.1" min="0" max="100">
                            </div>
                            <div class="form-group">
                                <label for="aliquota_saida">Alíquota Média de Saída:</label>
                                <input type="number" id="aliquota_saida" value="19" step="0.1" min="0" max="100">
                            </div>

                            <div class="incentivos-tab-container">
                                <div class="incentivos-tab-buttons">
                                    <button class="incentivos-tab-button active" data-incentivo-tab="saida">Incentivos de Saída</button>
                                    <button class="incentivos-tab-button" data-incentivo-tab="entrada">Incentivos de Entrada</button>
                                    <button class="incentivos-tab-button" data-incentivo-tab="apuracao">Incentivos de Apuração</button>
                                </div>
                                
                                <div id="incentivos-saida" class="incentivos-tab-content active">
                                    <table id="tabela-incentivos-saida">
                                        <thead>
                                            <tr>
                                                <th>Descrição</th>
                                                <th>Tipo</th>
                                                <th>Percentual</th>
                                                <th>% Operações</th>
                                                <th>Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                    <button onclick="adicionarIncentivo('saida')">Adicionar</button>
                                </div>

                                <div id="incentivos-entrada" class="incentivos-tab-content">
                                    <table id="tabela-incentivos-entrada">
                                        <thead>
                                            <tr>
                                                <th>Descrição</th>
                                                <th>Tipo</th>
                                                <th>Percentual</th>
                                                <th>% Operações</th>
                                                <th>Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                    <button onclick="adicionarIncentivo('entrada')">Adicionar</button>
                                </div>

                                <div id="incentivos-apuracao" class="incentivos-tab-content">
                                    <table id="tabela-incentivos-apuracao">
                                        <thead>
                                            <tr>
                                                <th>Descrição</th>
                                                <th>Tipo</th>
                                                <th>Percentual</th>
                                                <th>% do Saldo</th>
                                                <th>Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                    <button onclick="adicionarIncentivo('apuracao')">Adicionar</button>
                                </div>
                            </div>
                        </div>

                        <div class="group-box">
                            <h3>Parâmetros da Simulação</h3>
                            <div class="form-group">
                                <label for="ano_inicial">Ano Inicial:</label>
                                <input type="number" id="ano_inicial" value="2026" min="2026" max="2033">
                            </div>
                            <div class="form-group">
                                <label for="ano_final">Ano Final:</label>
                                <input type="number" id="ano_final" value="2033" min="2026" max="2033">
                            </div>
                        </div>

                        <button id="btn-simular" style="width: 100%; padding: 15px; font-size: 16px;">Simular</button>
                    </div>

                    <!-- Painel de resultados -->
                    <div class="panel">
                        <div class="group-box">
                            <h3>Resultados da Simulação</h3>
                            <table id="tabela-resultados">
                                <thead>
                                    <tr>
                                        <th>Ano</th>
                                        <th>CBS</th>
                                        <th>IBS</th>
                                        <th>Subtotal Novo</th>
                                        <th>PIS/COFINS</th>
                                        <th>ICMS</th>
                                        <th>ISS/IPI</th>
                                        <th>Subtotal Atual</th>
                                        <th>Total</th>
                                        <th>Var. Carga (%)</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>

                        <div class="group-box">
                            <h3>Gráficos Comparativos</h3>
                            <div class="chart-container">
                                <canvas id="grafico-comparativo"></canvas>
                            </div>
                            <div class="chart-container">
                                <canvas id="grafico-aliquotas"></canvas>
                            </div>
                            <div class="chart-container">
                                <canvas id="grafico-transicao"></canvas>
                            </div>
                            <div class="chart-container">
                                <canvas id="grafico-incentivos"></canvas>
                            </div>
                        </div>

                        <div class="group-box">
                            <h3>Exportar Resultados</h3>
                            <div class="button-group">
                                <button id="btn-exportar-pdf">Exportar PDF</button>
                                <button id="btn-exportar-excel">Exportar Excel</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Configurações Tab -->
            <div id="configuracoes" class="tab-content">
                <div class="group-box">
                    <h3>Alíquotas Base</h3>
                    <div class="form-group">
                        <label for="config-cbs">Alíquota CBS (%):</label>
                        <input type="number" id="config-cbs" value="8.8" step="0.1" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label for="config-ibs">Alíquota IBS (%):</label>
                        <input type="number" id="config-ibs" value="17.7" step="0.1" min="0" max="100">
                    </div>
                </div>

                <div class="group-box">
                    <h3>Fases de Transição</h3>
                    <table id="tabela-fases">
                        <thead>
                            <tr>
                                <th>Ano</th>
                                <th>Percentual</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>2026</td><td><input type="number" data-ano="2026" value="10" step="1" min="0" max="100"></td></tr>
                            <tr><td>2027</td><td><input type="number" data-ano="2027" value="25" step="1" min="0" max="100"></td></tr>
                            <tr><td>2028</td><td><input type="number" data-ano="2028" value="40" step="1" min="0" max="100"></td></tr>
                            <tr><td>2029</td><td><input type="number" data-ano="2029" value="60" step="1" min="0" max="100"></td></tr>
                            <tr><td>2030</td><td><input type="number" data-ano="2030" value="80" step="1" min="0" max="100"></td></tr>
                            <tr><td>2031</td><td><input type="number" data-ano="2031" value="90" step="1" min="0" max="100"></td></tr>
                            <tr><td>2032</td><td><input type="number" data-ano="2032" value="95" step="1" min="0" max="100"></td></tr>
                            <tr><td>2033</td><td><input type="number" data-ano="2033" value="100" step="1" min="0" max="100"></td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="group-box">
                    <h3>Alíquotas Setoriais</h3>
                    <table id="tabela-setores">
                        <thead>
                            <tr>
                                <th>Setor</th>
                                <th>IBS (%)</th>
                                <th>Redução CBS (%)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>Padrão</td><td><input type="number" data-setor="padrao" data-campo="ibs" value="17.7" step="0.1"></td><td><input type="number" data-setor="padrao" data-campo="reducao" value="0" step="0.1"></td></tr>
                            <tr><td>Educação</td><td><input type="number" data-setor="educacao" data-campo="ibs" value="12.5" step="0.1"></td><td><input type="number" data-setor="educacao" data-campo="reducao" value="40" step="0.1"></td></tr>
                            <tr><td>Saúde</td><td><input type="number" data-setor="saude" data-campo="ibs" value="14.5" step="0.1"></td><td><input type="number" data-setor="saude" data-campo="reducao" value="30" step="0.1"></td></tr>
                            <tr><td>Alimentos</td><td><input type="number" data-setor="alimentos" data-campo="ibs" value="12.0" step="0.1"></td><td><input type="number" data-setor="alimentos" data-campo="reducao" value="25" step="0.1"></td></tr>
                            <tr><td>Transporte</td><td><input type="number" data-setor="transporte" data-campo="ibs" value="15.0" step="0.1"></td><td><input type="number" data-setor="transporte" data-campo="reducao" value="20" step="0.1"></td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="button-group">
                    <button id="btn-salvar-config">Salvar Configurações</button>
                    <button id="btn-carregar-config">Carregar Configurações</button>
                    <button id="btn-restaurar-config">Restaurar Padrões</button>
                </div>
            </div>

            <!-- Memória de Cálculo Tab -->
            <div id="memoria" class="tab-content">
                <div class="form-group">
                    <label for="select-ano-memoria">Selecione o ano:</label>
                    <select id="select-ano-memoria"></select>
                </div>
                <button id="btn-atualizar-memoria">Atualizar Memória</button>
                <div id="memoria-calculo"></div>
                <button id="btn-exportar-memoria">Exportar Memória de Cálculo</button>
            </div>

            <!-- Ajuda Tab -->
            <div id="ajuda" class="tab-content">
                <div class="help-section">
                    <h3>Reforma Tributária - LC 214/2025</h3>
                    <p>Este simulador implementa as regras do IVA Dual (CBS/IBS) conforme a Lei Complementar 214/2025, que institui a Reforma Tributária.</p>
                </div>

                <div class="help-section">
                    <h3>Principais Pontos da Reforma</h3>
                    <ul>
                        <li><strong>IVA Dual</strong>: Substituição de cinco tributos (PIS, COFINS, IPI, ICMS, ISS) pelo CBS (federal) e IBS (estadual/municipal).</li>
                        <li><strong>Alíquotas Base</strong>: CBS de 8,8% e IBS de 17,7%, totalizando 26,5%.</li>
                        <li><strong>Não-Cumulatividade</strong>: Crédito integral de impostos pagos em etapas anteriores da cadeia.</li>
                        <li><strong>Transição</strong>: Implementação gradual entre 2026 e 2033.</li>
                        <li><strong>Regimes Diferenciados</strong>: Setores como educação, saúde e alimentos básicos com alíquotas reduzidas.</li>
                        <li><strong>Simples Nacional</strong>: Empresas do Simples continuam com regime simplificado, mas com ajustes.</li>
                        <li><strong>Cashback</strong>: Devolução de tributos para famílias de baixa renda.</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>Como Usar o Simulador</h3>
                    <ol>
                        <li><strong>Insira os dados da empresa</strong> na aba Simulação:
                            <ul>
                                <li>Faturamento anual</li>
                                <li>Custos tributáveis para PIS/COFINS/IVA/CBS (inclui serviços, insumos não incluídos no produto, etc.)</li>
                                <li>Custos tributáveis específicos para ICMS (geralmente mais restrito, inclui apenas insumos que compõem o produto)</li>
                                <li>Custos de fornecedores do Simples</li>
                                <li>Setor de atividade e regime tributário</li>
                            </ul>
                        </li>
                        <li><strong>Defina o período</strong> que deseja simular (anos inicial e final).</li>
                        <li><strong>Clique em 'Simular'</strong> para ver os resultados.</li>
                        <li><strong>Analise os resultados</strong> na tabela e nos gráficos comparativos.</li>
                        <li><strong>Personalize as configurações</strong> na aba Configurações para cenários específicos.</li>
                        <li><strong>Exporte os resultados</strong> em PDF ou Excel para análise posterior.</li>
                    </ol>
                </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            &copy; 2025 Expertzy Inteligência Tributária
        </div>
    </div>

    <!-- Modal para adicionar/editar incentivos -->
    <div id="modal-incentivo" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-titulo">Adicionar Incentivo</h3>
                <span class="close">&times;</span>
            </div>
            <div class="form-group">
                <label for="modal-descricao">Descrição:</label>
                <input type="text" id="modal-descricao">
            </div>
            <div class="form-group">
                <label for="modal-tipo">Tipo:</label>
                <select id="modal-tipo">
                    <option value="Nenhum">Nenhum</option>
                    <option value="Redução de Alíquota">Redução de Alíquota</option>
                    <option value="Crédito Presumido/Outorgado">Crédito Presumido/Outorgado</option>
                    <option value="Redução de Base de Cálculo">Redução de Base de Cálculo</option>
                    <option value="Diferimento">Diferimento</option>
                </select>
            </div>
            <div class="form-group">
                <label for="modal-percentual">Percentual (%):</label>
                <input type="number" id="modal-percentual" min="0" max="100" step="0.1">
            </div>
            <div class="form-group">
                <label for="modal-operacoes">% Operações Abrangidas:</label>
                <input type="number" id="modal-operacoes" min="0" max="100" step="0.1" value="100">
            </div>
            <div class="button-group">
                <button id="modal-salvar">Salvar</button>
                <button id="modal-cancelar">Cancelar</button>
            </div>
        </div>
    </div>
    
</body>
</html>
    <script>        
        // Manter as classes de cálculo das partes 1 e 2...
        // Classes para a lógica de negócio - Parte 1: Classes de Cálculo
        class ConfiguracaoTributaria {
            constructor() {
                // Alíquotas base do IVA Dual conforme Art. 12º, LC 214/2025
                this.aliquotas_base = {
                    "CBS": 0.088,  // 8,8%
                    "IBS": 0.177   // 17,7%
                };

                // Percentual progressivo (2026-2033) - Anexo III, LC 214/2025
                this.fase_transicao = {};
                this.fase_transicao[2026] = 0.10;  // 10% de implementação
                this.fase_transicao[2027] = 0.25;  // 25% de implementação
                this.fase_transicao[2028] = 0.40;  // 40% de implementação
                this.fase_transicao[2029] = 0.60;  // 60% de implementação
                this.fase_transicao[2030] = 0.80;  // 80% de implementação
                this.fase_transicao[2031] = 0.90;  // 90% de implementação
                this.fase_transicao[2032] = 0.95;  // 95% de implementação
                this.fase_transicao[2033] = 1.00;  // Implementação completa

                // Setores com alíquotas diferenciadas - Art. 18º, §§ 2º-5º
                this.setores_especiais = {
                    "padrao": {"IBS": 0.177, "reducao_CBS": 0.0},
                    "educacao": {"IBS": 0.125, "reducao_CBS": 0.40},  // Educação básica
                    "saude": {"IBS": 0.145, "reducao_CBS": 0.30},  // Serviços médicos
                    "alimentos": {"IBS": 0.120, "reducao_CBS": 0.25},  // Alimentos básicos
                    "transporte": {"IBS": 0.150, "reducao_CBS": 0.20}  // Transporte coletivo
                };

                // Produtos com alíquota zero (Anexos I e XV)
                this.produtos_aliquota_zero = [
                    "Arroz", "Feijão", "Leite", "Pão", "Frutas", "Hortaliças"
                ];

                // Limite para enquadramento no Simples Nacional - Art. 34º
                this.limite_simples = 4800000;

                // Regras de crédito - Art. 29º
                this.regras_credito = {
                    "normal": 1.0,  // Crédito integral
                    "simples": 0.20,  // Limitado a 20% do valor da compra
                    "rural": 0.60,  // Produtor rural: 60% sobre CBS
                    "importacoes": {"IBS": 1.0, "CBS": 0.50}  // Importações: 100% IBS, 50% CBS
                };

                // Adicionar configurações para os impostos atuais
                this.impostos_atuais = {
                    "PIS": 0.0165,  // 1,65%
                    "COFINS": 0.076,  // 7,6%
                    "IPI": {
                        "padrao": 0.10,  // 10% (média, varia por produto)
                        "industria": 0.15  // 15% para indústria
                    },
                    "ICMS": {
                        "padrao": 0.19,  // 19% (média estadual)
                        "comercio": 0.19,  // Comércio
                        "industria": 0.19,  // Indústria
                        "servicos": 0.19  // Serviços (quando aplicável)
                    },
                    "ISS": {
                        "padrao": 0.05,  // 5% (média municipal)
                        "servicos": 0.05  // Serviços
                    }
                };

                // Configurações para ICMS e incentivos fiscais
                this.icms_config = {
                    "aliquota_entrada": 0.19,  // 19% padrão
                    "aliquota_saida": 0.19,  // 19% padrão
                    "incentivos_saida": [],  // Lista de dicionários para incentivos de saída
                    "incentivos_entrada": [],  // Lista de dicionários para incentivos de entrada
                    "incentivos_apuracao": []  // Lista de dicionários para incentivos de apuração
                };

                // Estrutura de exemplo para incentivos
                this.incentivo_template = {
                    "tipo": "Nenhum",  // Tipos atualizados conforme necessário
                    "descricao": "",  // Descrição do incentivo (ex: "PRODEPE", "Fomentar", etc)
                    "percentual": 0.0,  // Percentual do incentivo
                    "percentual_operacoes": 1.0,  // Percentual das operações que recebem o incentivo
                    "aplicavel_entradas": false,  // Se o incentivo se aplica às entradas
                    "aplicavel_saidas": false,  // Se o incentivo se aplica às saídas
                    "aplicavel_apuracao": false  // Se o incentivo se aplica à apuração
                };

                // Cronograma de redução progressiva dos impostos durante a transição
                this.reducao_impostos_transicao = {
                    2026: {"PIS": 0.0, "COFINS": 0.0, "IPI": 0.0, "ICMS": 0.0, "ISS": 0.0},
                    2027: {"PIS": 1.0, "COFINS": 1.0, "IPI": 0.0, "ICMS": 0.0, "ISS": 0.0},
                    2028: {"PIS": 1.0, "COFINS": 1.0, "IPI": 0.3, "ICMS": 0.33, "ISS": 0.40},
                    2029: {"PIS": 1.0, "COFINS": 1.0, "IPI": 0.6, "ICMS": 0.56, "ISS": 0.70},
                    2030: {"PIS": 1.0, "COFINS": 1.0, "IPI": 0.8, "ICMS": 0.70, "ISS": 0.80},
                    2031: {"PIS": 1.0, "COFINS": 1.0, "IPI": 0.9, "ICMS": 0.80, "ISS": 0.90},
                    2032: {"PIS": 1.0, "COFINS": 1.0, "IPI": 0.95, "ICMS": 0.95, "ISS": 0.95},
                    2033: {"PIS": 1.0, "COFINS": 1.0, "IPI": 1.0, "ICMS": 1.0, "ISS": 1.0}
                };

                // Regras de créditos cruzados
                this.creditos_cruzados = {
                    2028: {"IBS_para_ICMS": 0.40},  // 40% do IBS pode compensar ICMS
                    2029: {"IBS_para_ICMS": 0.50},  // 50% do IBS pode compensar ICMS
                    2030: {"IBS_para_ICMS": 0.60},
                    2031: {"IBS_para_ICMS": 0.70},
                    2032: {"IBS_para_ICMS": 0.80}
                };
            }

            carregarConfiguracoes(configuracao) {
                if (configuracao) {
                    if (configuracao.aliquotas_base) {
                        this.aliquotas_base = configuracao.aliquotas_base;
                    }
                    if (configuracao.fase_transicao) {
                        this.fase_transicao = configuracao.fase_transicao;
                    }
                    if (configuracao.setores_especiais) {
                        this.setores_especiais = configuracao.setores_especiais;
                    }
                    if (configuracao.limite_simples) {
                        this.limite_simples = configuracao.limite_simples;
                    }
                    if (configuracao.regras_credito) {
                        this.regras_credito = configuracao.regras_credito;
                    }
                    return true;
                }
                return false;
            }

            obterAliquotasEfetivas(setor, ano) {
                // Obter fator de implementação para o ano
                const fator_implementacao = this.fase_transicao[ano] || 1.0;
                
                // Obter regras específicas do setor
                const regras_setor = this.setores_especiais[setor] || this.setores_especiais["padrao"];
                
                // Calcular alíquotas efetivas
                const cbs_efetivo = this.aliquotas_base["CBS"] * (1 - regras_setor["reducao_CBS"]) * fator_implementacao;
                const ibs_efetivo = regras_setor["IBS"] * fator_implementacao;
                
                return {
                    "CBS": cbs_efetivo,
                    "IBS": ibs_efetivo,
                    "total": cbs_efetivo + ibs_efetivo
                };
            }
        }

        class CalculadoraTributosAtuais {
            constructor(configuracao) {
                this.config = configuracao;
                this.memoria_calculo = {}; // Para armazenar os passos do cálculo
            }

            calcular_todos_impostos(dados, ano) {
                try {
                    // Limpar memória de cálculo anterior
                    this.memoria_calculo = {
                        "PIS": [],
                        "COFINS": [],
                        "ICMS": [],
                        "ISS": [],
                        "IPI": [],
                        "total": []
                    };

                    // Obter dados básicos
                    const faturamento = dados["faturamento"] || 0;
                    const custos_piscofins = dados["custos_tributaveis"] || 0;
                    const custos_icms = dados["custos_icms"] || 0;
                    const setor = dados["setor"] || "padrao";

                    // Cálculo do PIS
                    const aliquota_pis = this.config.impostos_atuais["PIS"];
                    this.memoria_calculo["PIS"].push(`Faturamento: R$ ${formatarBR(faturamento)}`);
                    this.memoria_calculo["PIS"].push(`Alíquota PIS: ${formatarBR(aliquota_pis * 100)}%`);

                    let credito_pis = 0;
                    if (faturamento > 0) {
                        credito_pis = custos_piscofins * aliquota_pis;
                        this.memoria_calculo["PIS"].push(`Custos tributáveis (PIS): R$ ${formatarBR(custos_piscofins)}`);
                        this.memoria_calculo["PIS"].push(
                            `Crédito PIS: R$ ${formatarBR(custos_piscofins)} × ${formatarBR(aliquota_pis * 100)}% = R$ ${formatarBR(credito_pis)}`);
                    }

                    const pis_devido = faturamento * aliquota_pis - credito_pis;
                    this.memoria_calculo["PIS"].push(
                        `PIS bruto: R$ ${formatarBR(faturamento)} × ${formatarBR(aliquota_pis * 100)}% = R$ ${formatarBR(faturamento * aliquota_pis)}`);
                    this.memoria_calculo["PIS"].push(
                        `PIS devido: R$ ${formatarBR(faturamento * aliquota_pis)} - R$ ${formatarBR(credito_pis)} = R$ ${formatarBR(pis_devido)}`);

                    // Cálculo do COFINS com base nos custos para PIS/COFINS
                    const aliquota_cofins = this.config.impostos_atuais["COFINS"];
                    this.memoria_calculo["COFINS"].push(`Faturamento: R$ ${formatarBR(faturamento)}`);
                    this.memoria_calculo["COFINS"].push(`Alíquota COFINS: ${formatarBR(aliquota_cofins * 100)}%`);

                    let credito_cofins = 0;
                    if (faturamento > 0) {
                        credito_cofins = custos_piscofins * aliquota_cofins;
                        this.memoria_calculo["COFINS"].push(`Custos tributáveis (COFINS): R$ ${formatarBR(custos_piscofins)}`);
                        this.memoria_calculo["COFINS"].push(
                            `Crédito COFINS: R$ ${formatarBR(custos_piscofins)} × ${formatarBR(aliquota_cofins * 100)}% = R$ ${formatarBR(credito_cofins)}`);
                    }

                    const cofins_devido = faturamento * aliquota_cofins - credito_cofins;
                    this.memoria_calculo["COFINS"].push(
                        `COFINS bruto: R$ ${formatarBR(faturamento)} × ${formatarBR(aliquota_cofins * 100)}% = R$ ${formatarBR(faturamento * aliquota_cofins)}`);
                    this.memoria_calculo["COFINS"].push(
                        `COFINS devido: R$ ${formatarBR(faturamento * aliquota_cofins)} - R$ ${formatarBR(credito_cofins)} = R$ ${formatarBR(cofins_devido)}`);

                    // Atualizar dados para o cálculo do ICMS
                    const dados_icms = {...dados, custos_tributaveis: custos_icms};
                    
                    // Cálculo do ICMS usando a base de custos específica
                    const resultado_icms = this.calcular_icms_detalhado(dados_icms);
                    const icms_devido = resultado_icms["icms_devido"];

                    // Atualizar a memória de cálculo
                    this.memoria_calculo["ICMS"] = resultado_icms["memoria_calculo"];

                    // Cálculo do ISS (apenas para setores de serviços)
                    let iss_devido = 0;
                    if (["servicos", "educacao", "saude"].includes(setor)) {
                        const aliquota_iss = this.config.impostos_atuais["ISS"]["padrao"];
                        iss_devido = faturamento * aliquota_iss;

                        this.memoria_calculo["ISS"].push(`Faturamento: R$ ${formatarBR(faturamento)}`);
                        this.memoria_calculo["ISS"].push(`Alíquota ISS: ${formatarBR(aliquota_iss * 100)}%`);
                        this.memoria_calculo["ISS"].push(
                            `ISS devido: R$ ${formatarBR(faturamento)} × ${formatarBR(aliquota_iss * 100)}% = R$ ${formatarBR(iss_devido)}`);
                    } else {
                        this.memoria_calculo["ISS"].push(`Não aplicável ao setor ${setor}`);
                    }

                    // Cálculo do IPI (apenas para indústria)
                    let ipi_devido = 0;
                    if (setor === "industria") {
                        const aliquota_ipi = this.config.impostos_atuais["IPI"]["industria"];
                        const fator_credito_ipi = 0.7;  // Fator de aproveitamento de crédito do IPI

                        let credito_ipi = 0;
                        if (faturamento > 0) {
                            credito_ipi = custos * aliquota_ipi * fator_credito_ipi;
                        }

                        ipi_devido = faturamento * aliquota_ipi - credito_ipi;

                        this.memoria_calculo["IPI"].push(`Faturamento: R$ ${formatarBR(faturamento)}`);
                        this.memoria_calculo["IPI"].push(`Alíquota IPI: ${formatarBR(aliquota_ipi * 100)}%`);
                        this.memoria_calculo["IPI"].push(`Custos tributáveis: R$ ${formatarBR(custos)}`);
                        this.memoria_calculo["IPI"].push(`Fator de aproveitamento: ${formatarBR(fator_credito_ipi * 100)}%`);
                        this.memoria_calculo["IPI"].push(
                            `Crédito IPI: R$ ${formatarBR(custos)} × ${formatarBR(aliquota_ipi * 100)}% × ${formatarBR(fator_credito_ipi * 100)}% = R$ ${formatarBR(credito_ipi)}`);
                        this.memoria_calculo["IPI"].push(
                            `IPI bruto: R$ ${formatarBR(faturamento)} × ${formatarBR(aliquota_ipi * 100)}% = R$ ${formatarBR(faturamento * aliquota_ipi)}`);
                        this.memoria_calculo["IPI"].push(
                            `IPI devido: R$ ${formatarBR(faturamento * aliquota_ipi)} - R$ ${formatarBR(credito_ipi)} = R$ ${formatarBR(ipi_devido)}`);
                    } else {
                        this.memoria_calculo["IPI"].push(`Não aplicável ao setor ${setor}`);
                    }

                    // Cálculo do total
                    const total = pis_devido + cofins_devido + icms_devido + iss_devido + ipi_devido;
                    this.memoria_calculo["total"].push(`Total de tributos = PIS + COFINS + ICMS + ISS + IPI`);
                    this.memoria_calculo["total"].push(
                        `Total de tributos = R$ ${formatarBR(pis_devido)} + R$ ${formatarBR(cofins_devido)} + R$ ${formatarBR(icms_devido)} + R$ ${formatarBR(iss_devido)} + R$ ${formatarBR(ipi_devido)}`);
                    this.memoria_calculo["total"].push(`Total de tributos = R$ ${formatarBR(total)}`);

                    // Retornar os resultados
                    const impostos = {
                        "PIS": pis_devido,
                        "COFINS": cofins_devido,
                        "ICMS": icms_devido,
                        "ISS": iss_devido,
                        "IPI": ipi_devido,
                        "total": total,
                        "economia_icms": resultado_icms["economia_tributaria"]  // Novo campo
                    };

                    return impostos;

                } catch (e) {
                    console.error(`Erro no cálculo de impostos atuais: ${e}`);
                    // Retornar valores padrão em caso de erro
                    return {"PIS": 0, "COFINS": 0, "ICMS": 0, "ISS": 0, "IPI": 0, "total": 0};
                }
            }

            calcular_icms_detalhado(dados) {
                try {
                    // Obter dados básicos
                    const faturamento = dados["faturamento"] || 0;
                    const custos = dados["custos_tributaveis"] || 0; // Agora são os custos específicos para ICMS

                    // Obter configurações específicas do ICMS
                    const aliquota_entrada = this.config.icms_config["aliquota_entrada"] || 0.19;
                    const aliquota_saida = this.config.icms_config["aliquota_saida"] || 0.19;
                    const incentivos_saida = this.config.icms_config["incentivos_saida"] || [];
                    const incentivos_entrada = this.config.icms_config["incentivos_entrada"] || [];
                    const incentivos_apuracao = this.config.icms_config["incentivos_apuracao"] || [];

                    // Criar memória de cálculo detalhada
                    let memoria_calculo = [];
                    memoria_calculo.push(`Faturamento: R$ ${formatarBR(faturamento)}`);
                    memoria_calculo.push(`Custos tributáveis (ICMS): R$ ${formatarBR(custos)}`);
                    memoria_calculo.push(`Alíquota média de entrada: ${formatarBR(aliquota_entrada * 100)}%`);
                    memoria_calculo.push(`Alíquota média de saída: ${formatarBR(aliquota_saida * 100)}%`);

                    // Calcular débito e crédito normais (sem incentivo)
                    const debito_icms_normal = faturamento * aliquota_saida;
                    const credito_normal = custos * aliquota_entrada;

                    memoria_calculo.push(
                        `Débito ICMS (sem incentivo): R$ ${formatarBR(faturamento)} × ${formatarBR(aliquota_saida * 100)}% = R$ ${formatarBR(debito_icms_normal)}`);
                    memoria_calculo.push(
                        `Crédito normal: R$ ${formatarBR(custos)} × ${formatarBR(aliquota_entrada * 100)}% = R$ ${formatarBR(credito_normal)}`);

                    // Se não houver incentivos configurados, retornar cálculo padrão
                    if (incentivos_saida.length === 0 && incentivos_entrada.length === 0 && incentivos_apuracao.length === 0) {
                        const icms_devido = debito_icms_normal - credito_normal;
                        memoria_calculo.push(`Nenhum incentivo fiscal aplicado`);
                        memoria_calculo.push(
                            `ICMS devido: R$ ${formatarBR(debito_icms_normal)} - R$ ${formatarBR(credito_normal)} = R$ ${formatarBR(icms_devido)}`);

                        // Calcular economia tributária
                        const economia = 0;
                        const percentual_economia = 0;

                        memoria_calculo.push(`\nComparativo:`);
                        memoria_calculo.push(`ICMS sem incentivo: R$ ${formatarBR(icms_devido)}`);
                        memoria_calculo.push(`ICMS com incentivo: R$ ${formatarBR(icms_devido)}`);
                        memoria_calculo.push(
                            `Economia tributária: R$ ${formatarBR(economia)} (${formatarBR(percentual_economia)}%)`);

                        return {
                            "icms_devido": Math.max(0, icms_devido),
                            "economia_tributaria": economia,
                            "percentual_economia": percentual_economia,
                            "memoria_calculo": memoria_calculo
                        };
                    }

                    // Processar incentivos de saída (débitos)
                    let debito_total = 0;
                    let faturamento_nao_incentivado = faturamento;

                    memoria_calculo.push(`\n== Processando incentivos para débitos de ICMS (saídas) ==`);

                    for (let idx = 0; idx < incentivos_saida.length; idx++) {
                        const incentivo = incentivos_saida[idx];
                        const tipo = incentivo["tipo"] || "Nenhum";
                        const percentual = incentivo["percentual"] || 0.0;
                        const percentual_operacoes = incentivo["percentual_operacoes"] || 1.0;
                        const descricao = incentivo["descricao"] || `Incentivo ${idx + 1}`;

                        if (tipo === "Nenhum" || percentual <= 0) {
                            continue;
                        }

                        const faturamento_incentivado = faturamento_nao_incentivado * percentual_operacoes;
                        faturamento_nao_incentivado -= faturamento_incentivado;

                        memoria_calculo.push(`\nIncentivo de saída ${idx + 1}: ${descricao}`);
                        memoria_calculo.push(`Tipo: ${tipo}`);
                        memoria_calculo.push(`Percentual do incentivo: ${formatarBR(percentual * 100)}%`);
                        memoria_calculo.push(`Percentual de operações: ${formatarBR(percentual_operacoes * 100)}%`);
                        memoria_calculo.push(`Faturamento incentivado: R$ ${formatarBR(faturamento_incentivado)}`);

                        let debito_incentivado = 0;

                        if (tipo === "Redução de Alíquota") {
                            const aliquota_reduzida = aliquota_saida * (1 - percentual);
                            debito_incentivado = faturamento_incentivado * aliquota_reduzida;

                            memoria_calculo.push(
                                `Alíquota reduzida: ${formatarBR(aliquota_saida * 100)}% × (1 - ${formatarBR(percentual * 100)}%) = ${formatarBR(aliquota_reduzida * 100)}%`);
                            memoria_calculo.push(
                                `Débito com alíquota reduzida: R$ ${formatarBR(faturamento_incentivado)} × ${formatarBR(aliquota_reduzida * 100)}% = R$ ${formatarBR(debito_incentivado)}`);

                        } else if (tipo === "Crédito Presumido/Outorgado") {
                            debito_incentivado = faturamento_incentivado * aliquota_saida;
                            const credito_presumido = debito_incentivado * percentual;
                            debito_incentivado -= credito_presumido;

                            memoria_calculo.push(
                                `Débito normal: R$ ${formatarBR(faturamento_incentivado)} × ${formatarBR(aliquota_saida * 100)}% = R$ ${formatarBR(faturamento_incentivado * aliquota_saida)}`);
                            memoria_calculo.push(
                                `Crédito presumido/outorgado: R$ ${formatarBR(faturamento_incentivado * aliquota_saida)} × ${formatarBR(percentual * 100)}% = R$ ${formatarBR(credito_presumido)}`);
                            memoria_calculo.push(
                                `Débito após crédito presumido/outorgado: R$ ${formatarBR(faturamento_incentivado * aliquota_saida)} - R$ ${formatarBR(credito_presumido)} = R$ ${formatarBR(debito_incentivado)}`);

                        } else if (tipo === "Redução de Base de Cálculo") {
                            const base_reduzida = faturamento_incentivado * (1 - percentual);
                            debito_incentivado = base_reduzida * aliquota_saida;

                            memoria_calculo.push(
                                `Base de cálculo reduzida: R$ ${formatarBR(faturamento_incentivado)} × (1 - ${formatarBR(percentual * 100)}%) = R$ ${formatarBR(base_reduzida)}`);
                            memoria_calculo.push(
                                `Débito sobre base reduzida: R$ ${formatarBR(base_reduzida)} × ${formatarBR(aliquota_saida * 100)}% = R$ ${formatarBR(debito_incentivado)}`);

                        } else if (tipo === "Diferimento") {
                            const valor_diferido = faturamento_incentivado * aliquota_saida * percentual;
                            debito_incentivado = (faturamento_incentivado * aliquota_saida) - valor_diferido;

                            memoria_calculo.push(
                                `Valor total de débito: R$ ${formatarBR(faturamento_incentivado * aliquota_saida)}`);
                            memoria_calculo.push(
                                `Valor diferido: R$ ${formatarBR(faturamento_incentivado * aliquota_saida)} × ${formatarBR(percentual * 100)}% = R$ ${formatarBR(valor_diferido)}`);
                            memoria_calculo.push(
                                `Débito após diferimento: R$ ${formatarBR(faturamento_incentivado * aliquota_saida)} - R$ ${formatarBR(valor_diferido)} = R$ ${formatarBR(debito_incentivado)}`);

                        } else {
                            debito_incentivado = faturamento_incentivado * aliquota_saida;
                            memoria_calculo.push(`Tipo de incentivo não implementado, utilizando cálculo padrão`);
                            memoria_calculo.push(
                                `Débito: R$ ${formatarBR(faturamento_incentivado)} × ${formatarBR(aliquota_saida * 100)}% = R$ ${formatarBR(debito_incentivado)}`);
                        }

                        debito_total += debito_incentivado;
                    }

                    // Adicionar débito das operações não incentivadas
                    if (faturamento_nao_incentivado > 0) {
                        const debito_nao_incentivado = faturamento_nao_incentivado * aliquota_saida;
                        debito_total += debito_nao_incentivado;

                        memoria_calculo.push(`\nOperações não incentivadas:`);
                        memoria_calculo.push(`Faturamento não incentivado: R$ ${formatarBR(faturamento_nao_incentivado)}`);
                        memoria_calculo.push(
                            `Débito sobre operações não incentivadas: R$ ${formatarBR(faturamento_nao_incentivado)} × ${formatarBR(aliquota_saida * 100)}% = R$ ${formatarBR(debito_nao_incentivado)}`);
                    }

                    memoria_calculo.push(`\nTotal de débitos após incentivos: R$ ${formatarBR(debito_total)}`);

                    // Processar incentivos de entrada (créditos)
                    let credito_total = 0;
                    let custos_nao_incentivados = custos;

                    memoria_calculo.push(`\n== Processando incentivos para créditos de ICMS (entradas) ==`);

                    for (let idx = 0; idx < incentivos_entrada.length; idx++) {
                        const incentivo = incentivos_entrada[idx];
                        const tipo = incentivo["tipo"] || "Nenhum";
                        const percentual = incentivo["percentual"] || 0.0;
                        const percentual_operacoes = incentivo["percentual_operacoes"] || 1.0;
                        const descricao = incentivo["descricao"] || `Incentivo ${idx + 1}`;

                        if (tipo === "Nenhum" || percentual <= 0) {
                            continue;
                        }

                        const custos_incentivados = custos_nao_incentivados * percentual_operacoes;
                        custos_nao_incentivados -= custos_incentivados;

                        memoria_calculo.push(`\nIncentivo de entrada ${idx + 1}: ${descricao}`);
                        memoria_calculo.push(`Tipo: ${tipo}`);
                        memoria_calculo.push(`Percentual do incentivo: ${formatarBR(percentual * 100)}%`);
                        memoria_calculo.push(`Percentual de operações: ${formatarBR(percentual_operacoes * 100)}%`);
                        memoria_calculo.push(`Custos incentivados: R$ ${formatarBR(custos_incentivados)}`);

                        let credito_incentivado = 0;

                        if (tipo === "Redução de Alíquota") {
                            const aliquota_reduzida = aliquota_entrada * (1 - percentual);
                            credito_incentivado = custos_incentivados * aliquota_reduzida;

                            memoria_calculo.push(
                                `Alíquota reduzida: ${formatarBR(aliquota_entrada * 100)}% × (1 - ${formatarBR(percentual * 100)}%) = ${formatarBR(aliquota_reduzida * 100)}%`);
                            memoria_calculo.push(
                                `Crédito com alíquota reduzida: R$ ${formatarBR(custos_incentivados)} × ${formatarBR(aliquota_reduzida * 100)}% = R$ ${formatarBR(credito_incentivado)}`);

                        } else if (tipo === "Crédito Presumido/Outorgado") {
                            const credito_base = custos_incentivados * aliquota_entrada;
                            const credito_adicional = credito_base * percentual;
                            credito_incentivado = credito_base + credito_adicional;

                            memoria_calculo.push(
                                `Crédito base: R$ ${formatarBR(custos_incentivados)} × ${formatarBR(aliquota_entrada * 100)}% = R$ ${formatarBR(credito_base)}`);
                            memoria_calculo.push(
                                `Crédito adicional: R$ ${formatarBR(credito_base)} × ${formatarBR(percentual * 100)}% = R$ ${formatarBR(credito_adicional)}`);
                            memoria_calculo.push(
                                `Crédito total: R$ ${formatarBR(credito_base)} + R$ ${formatarBR(credito_adicional)} = R$ ${formatarBR(credito_incentivado)}`);

                        } else if (tipo === "Estorno de Crédito") {
                            const credito_base = custos_incentivados * aliquota_entrada;
                            const estorno = credito_base * percentual;
                            credito_incentivado = credito_base - estorno;

                            memoria_calculo.push(
                                `Crédito base: R$ ${formatarBR(custos_incentivados)} × ${formatarBR(aliquota_entrada * 100)}% = R$ ${formatarBR(credito_base)}`);
                            memoria_calculo.push(
                                `Estorno de crédito: R$ ${formatarBR(credito_base)} × ${formatarBR(percentual * 100)}% = R$ ${formatarBR(estorno)}`);
                            memoria_calculo.push(
                                `Crédito após estorno: R$ ${formatarBR(credito_base)} - R$ ${formatarBR(estorno)} = R$ ${formatarBR(credito_incentivado)}`);

                        } else {
                            credito_incentivado = custos_incentivados * aliquota_entrada;
                            memoria_calculo.push(
                                `Tipo de incentivo não implementado para entradas, utilizando cálculo padrão`);
                            memoria_calculo.push(
                                `Crédito: R$ ${formatarBR(custos_incentivados)} × ${formatarBR(aliquota_entrada * 100)}% = R$ ${formatarBR(credito_incentivado)}`);
                        }

                        credito_total += credito_incentivado;
                    }

                    // Adicionar crédito das operações não incentivadas
                    if (custos_nao_incentivados > 0) {
                        const credito_nao_incentivado = custos_nao_incentivados * aliquota_entrada;
                        credito_total += credito_nao_incentivado;

                        memoria_calculo.push(`\nOperações de entrada não incentivadas:`);
                        memoria_calculo.push(`Custos não incentivados: R$ ${formatarBR(custos_nao_incentivados)}`);
                        memoria_calculo.push(
                            `Crédito sobre operações não incentivadas: R$ ${formatarBR(custos_nao_incentivados)} × ${formatarBR(aliquota_entrada * 100)}% = R$ ${formatarBR(credito_nao_incentivado)}`);
                    }

                    memoria_calculo.push(`\nTotal de créditos após incentivos: R$ ${formatarBR(credito_total)}`);

                    // Cálculo do ICMS devido
                    let icms_devido = Math.max(0, debito_total - credito_total);

                    // Processar incentivos de apuração (aplicados sobre o saldo devedor)
                    const icms_antes_incentivos_apuracao = icms_devido;

                    memoria_calculo.push(`\n== Processando incentivos de apuração do ICMS ==`);
                    memoria_calculo.push(
                        `ICMS antes dos incentivos de apuração: R$ ${formatarBR(icms_antes_incentivos_apuracao)}`);

                    // Se não há saldo devedor ou incentivos de apuração, não aplicar
                    if (icms_antes_incentivos_apuracao <= 0 || incentivos_apuracao.length === 0) {
                        memoria_calculo.push(`Não há saldo devedor ou incentivos de apuração configurados.`);
                    } else {
                        let reducao_total = 0;

                        for (let idx = 0; idx < incentivos_apuracao.length; idx++) {
                            const incentivo = incentivos_apuracao[idx];
                            const tipo = incentivo["tipo"] || "Nenhum";
                            const percentual = incentivo["percentual"] || 0.0;
                            const percentual_saldo = incentivo["percentual_operacoes"] || 1.0;  // Percentual do saldo
                            const descricao = incentivo["descricao"] || `Incentivo Apuração ${idx + 1}`;

                            if (tipo === "Nenhum" || percentual <= 0) {
                                continue;
                            }

                            const saldo_afetado = icms_antes_incentivos_apuracao * percentual_saldo;

                            memoria_calculo.push(`\nIncentivo de apuração ${idx + 1}: ${descricao}`);
                            memoria_calculo.push(`Tipo: ${tipo}`);
                            memoria_calculo.push(`Percentual do incentivo: ${formatarBR(percentual * 100)}%`);
                            memoria_calculo.push(`Percentual do saldo: ${formatarBR(percentual_saldo * 100)}%`);
                            memoria_calculo.push(`Saldo afetado: R$ ${formatarBR(saldo_afetado)}`);

                            let reducao = 0;

                            if (tipo === "Crédito Presumido/Outorgado") {
                                reducao = saldo_afetado * percentual;
                                memoria_calculo.push(
                                    `Crédito outorgado: R$ ${formatarBR(saldo_afetado)} × ${formatarBR(percentual * 100)}% = R$ ${formatarBR(reducao)}`);

                            } else if (tipo === "Redução do Saldo Devedor") {
                                reducao = saldo_afetado * percentual;
                                memoria_calculo.push(
                                    `Redução direta: R$ ${formatarBR(saldo_afetado)} × ${formatarBR(percentual * 100)}% = R$ ${formatarBR(reducao)}`);

                            } else {
                                memoria_calculo.push(`Tipo de incentivo não implementado para apuração`);
                            }

                            reducao_total += reducao;
                        }

                        // Aplicar reduções
                        icms_devido = Math.max(0, icms_antes_incentivos_apuracao - reducao_total);

                        memoria_calculo.push(`\nTotal de reduções de apuração: R$ ${formatarBR(reducao_total)}`);
                        memoria_calculo.push(`ICMS devido após incentivos de apuração: R$ ${formatarBR(icms_devido)}`);
                    }

                    memoria_calculo.push(`\n== Cálculo final do ICMS ==`);
                    memoria_calculo.push(`Débitos totais: R$ ${formatarBR(debito_total)}`);
                    memoria_calculo.push(`Créditos totais: R$ ${formatarBR(credito_total)}`);
                    memoria_calculo.push(
                        `ICMS devido: R$ ${formatarBR(debito_total)} - R$ ${formatarBR(credito_total)} = R$ ${formatarBR(icms_devido)}`);

                    // Calcular economia tributária
                    const icms_sem_incentivo = Math.max(0, debito_icms_normal - credito_normal);
                    const economia = icms_sem_incentivo - icms_devido;
                    const percentual_economia = icms_sem_incentivo > 0 ? (economia / icms_sem_incentivo) * 100 : 0;

                    memoria_calculo.push(`\nComparativo:`);
                    memoria_calculo.push(`ICMS sem incentivo: R$ ${formatarBR(icms_sem_incentivo)}`);
                    memoria_calculo.push(`ICMS com incentivo: R$ ${formatarBR(icms_devido)}`);
                    memoria_calculo.push(
                        `Economia tributária: R$ ${formatarBR(economia)} (${formatarBR(percentual_economia)}%)`);

                    return {
                        "icms_devido": Math.max(0, icms_devido),  // Garantir que não seja negativo
                        "economia_tributaria": economia,
                        "percentual_economia": percentual_economia,
                        "memoria_calculo": memoria_calculo
                    };

                } catch (e) {
                    console.error(`Erro no cálculo detalhado do ICMS: ${e}`);
                    return {
                        "icms_devido": 0,
                        "economia_tributaria": 0,
                        "percentual_economia": 0,
                        "memoria_calculo": [`Erro no cálculo: ${e.toString()}`]
                    };
                }
            }

            obter_memoria_calculo() {
                return this.memoria_calculo;
            }
        }
        // Continuação da classe CalculadoraIVADual que estava incompleta
        class CalculadoraIVADual {
            constructor(configuracao) {
                this.config = configuracao;
                this.memoria_calculo = {};  // Para armazenar os passos do cálculo
                this.calculadora_atual = null;
            }

            validar_dados(dados) {
                if (dados["faturamento"] < 0) {
                    throw new Error("Faturamento não pode ser negativo");
                }
                if (dados["custos_tributaveis"] > dados["faturamento"]) {
                    throw new Error("Custos tributáveis não podem exceder o faturamento");
                }
                if (dados["regime"] === "simples" && dados["faturamento"] > this.config.limite_simples) {
                    throw new Error(
                        `Empresas do Simples Nacional devem ter faturamento anual até R$ ${formatarBR(this.config.limite_simples)}`);
                }
                return true;
            }

            calcular_base_tributavel(dados, ano) {
                const fator_transicao = this.config.fase_transicao[ano] || 1.0;

                // Base de cálculo = Faturamento × (Fator de Transição)
                let base = dados["faturamento"] * fator_transicao;

                // Registrar memória de cálculo
                if (!this.memoria_calculo["base_tributavel"]) {
                    this.memoria_calculo["base_tributavel"] = [];
                }

                this.memoria_calculo["base_tributavel"].push(`Faturamento: R$ ${formatarBR(dados['faturamento'])}`);
                this.memoria_calculo["base_tributavel"].push(
                    `Fator de Transição (${ano}): ${formatarBR(fator_transicao * 100)}%`);
                this.memoria_calculo["base_tributavel"].push(
                    `Base de Cálculo: R$ ${formatarBR(dados['faturamento'])} × ${formatarBR(fator_transicao * 100)}% = R$ ${formatarBR(base)}`);

                // Ajuste para setores especiais
                if (this.config.setores_especiais[dados["setor"]] && dados["setor"] !== "padrao") {
                    const base_especial = dados["faturamento"] * (fator_transicao * 0.5);  // Redução adicional de 50% na base
                    this.memoria_calculo["base_tributavel"].push(
                        `Setor especial (${dados["setor"]}): Redução adicional de 50% na base`);
                    this.memoria_calculo["base_tributavel"].push(
                        `Base de Cálculo Ajustada: R$ ${formatarBR(dados['faturamento'])} × (${formatarBR(fator_transicao * 100)}% × 0,5) = R$ ${formatarBR(base_especial)}`);
                    return base_especial;
                }

                return base;
            }

            calcular_creditos(dados, ano) {
                // Separar custos por origem
                const custos_normais = dados["custos_tributaveis"] || 0; // Base para IVA/CBS/PIS/COFINS
                const custos_simples = dados["custos_simples"] || 0;
                const custos_rurais = dados["custos_rurais"] || 0;
                const custos_importacoes = dados["custos_importacoes"] || 0;
                const custos_icms = dados["custos_icms"] || 0; // Nova base para ICMS

                // Obter alíquotas efetivas
                const aliquotas = this.config.obterAliquotasEfetivas(dados["setor"], ano);

                // Registrar memória de cálculo
                if (!this.memoria_calculo["creditos"]) {
                    this.memoria_calculo["creditos"] = [];
                }

                this.memoria_calculo["creditos"].push(`Alíquotas efetivas para ${dados["setor"]} em ${ano}:`);
                this.memoria_calculo["creditos"].push(`CBS: ${formatarBR(aliquotas['CBS'] * 100)}%`);
                this.memoria_calculo["creditos"].push(`IBS: ${formatarBR(aliquotas['IBS'] * 100)}%`);
                this.memoria_calculo["creditos"].push(`Total: ${formatarBR(aliquotas['total'] * 100)}%`);

                // Calcular créditos por tipo de origem
                let creditos = 0;

                // Créditos de fornecedores do regime normal
                if (custos_normais > 0) {
                    const credito_normal = custos_normais * (aliquotas["CBS"] + aliquotas["IBS"]);
                    this.memoria_calculo["creditos"].push(`\nCréditos de Fornecedores do Regime Normal:`);
                    this.memoria_calculo["creditos"].push(`Custos tributáveis (IVA/CBS): R$ ${formatarBR(custos_normais)}`);
                    this.memoria_calculo["creditos"].push(
                        `Crédito: R$ ${formatarBR(custos_normais)} × (${formatarBR(aliquotas['CBS'] * 100)}% + ${formatarBR(aliquotas['IBS'] * 100)}%) = R$ ${formatarBR(credito_normal)}`);
                    creditos += credito_normal;
                }

                // Créditos do Simples Nacional (limitado a 20%)
                if (custos_simples > 0) {
                    const base_credito_simples = custos_simples * this.config.regras_credito["simples"];
                    const credito_simples = base_credito_simples * (aliquotas["CBS"] + aliquotas["IBS"]);

                    this.memoria_calculo["creditos"].push(`\nCréditos de Fornecedores do Simples Nacional:`);
                    this.memoria_calculo["creditos"].push(`Custos: R$ ${formatarBR(custos_simples)}`);
                    this.memoria_calculo["creditos"].push(
                        `Limite de aproveitamento: ${formatarBR(this.config.regras_credito['simples'] * 100)}%`);
                    this.memoria_calculo["creditos"].push(
                        `Base para crédito: R$ ${formatarBR(custos_simples)} × ${formatarBR(this.config.regras_credito['simples'] * 100)}% = R$ ${formatarBR(base_credito_simples)}`);
                    this.memoria_calculo["creditos"].push(
                        `Crédito: R$ ${formatarBR(base_credito_simples)} × (${formatarBR(aliquotas['CBS'] * 100)}% + ${formatarBR(aliquotas['IBS'] * 100)}%) = R$ ${formatarBR(credito_simples)}`);

                    // Limitação adicional (40% do imposto devido)
                    const imposto_devido = dados["imposto_devido"] || credito_simples * 2.5;
                    const limite_imposto = imposto_devido * 0.40;
                    const credito_final = Math.min(credito_simples, limite_imposto);

                    this.memoria_calculo["creditos"].push(
                        `Limite adicional (40% do imposto devido): R$ ${formatarBR(imposto_devido)} × 40% = R$ ${formatarBR(limite_imposto)}`);
                    this.memoria_calculo["creditos"].push(`Crédito final (menor valor): R$ ${formatarBR(credito_final)}`);

                    creditos += credito_final;
                }

                // Créditos de produtores rurais (60% sobre CBS)
                if (custos_rurais > 0) {
                    const credito_rural = custos_rurais * (
                            aliquotas["IBS"] + (aliquotas["CBS"] * this.config.regras_credito["rural"]));

                    this.memoria_calculo["creditos"].push(`\nCréditos de Produtores Rurais:`);
                    this.memoria_calculo["creditos"].push(`Custos: R$ ${formatarBR(custos_rurais)}`);
                    this.memoria_calculo["creditos"].push(
                        `Aproveitamento CBS: ${formatarBR(this.config.regras_credito['rural'] * 100)}%`);
                    this.memoria_calculo["creditos"].push(
                        `Crédito: R$ ${formatarBR(custos_rurais)} × (${formatarBR(aliquotas['IBS'] * 100)}% + (${formatarBR(aliquotas['CBS'] * 100)}% × ${formatarBR(this.config.regras_credito['rural'] * 100)}%)) = R$ ${formatarBR(credito_rural)}`);

                    creditos += credito_rural;
                }

                // Créditos de importações
                if (custos_importacoes > 0) {
                    const credito_importacao = custos_importacoes * (
                            aliquotas["IBS"] * this.config.regras_credito["importacoes"]["IBS"] +
                            aliquotas["CBS"] * this.config.regras_credito["importacoes"]["CBS"]
                    );

                    this.memoria_calculo["creditos"].push(`\nCréditos de Importações:`);
                    this.memoria_calculo["creditos"].push(`Custos: R$ ${formatarBR(custos_importacoes)}`);
                    this.memoria_calculo["creditos"].push(
                        `Aproveitamento IBS: ${formatarBR(this.config.regras_credito['importacoes']['IBS'] * 100)}%`);
                    this.memoria_calculo["creditos"].push(
                        `Aproveitamento CBS: ${formatarBR(this.config.regras_credito['importacoes']['CBS'] * 100)}%`);
                    this.memoria_calculo["creditos"].push(
                        `Crédito: R$ ${formatarBR(custos_importacoes)} × (${formatarBR(aliquotas['IBS'] * 100)}% × ${formatarBR(this.config.regras_credito['importacoes']['IBS'] * 100)}% + ${formatarBR(aliquotas['CBS'] * 100)}% × ${formatarBR(this.config.regras_credito['importacoes']['CBS'] * 100)}%) = R$ ${formatarBR(credito_importacao)}`);

                    creditos += credito_importacao;
                }

                // Adicionar créditos anteriores
                const creditos_anteriores = dados["creditos_anteriores"] || 0;
                if (creditos_anteriores > 0) {
                    this.memoria_calculo["creditos"].push(`\nCréditos Anteriores:`);
                    this.memoria_calculo["creditos"].push(`Valor: R$ ${formatarBR(creditos_anteriores)}`);
                    creditos += creditos_anteriores;
                }

                // Total de créditos
                this.memoria_calculo["creditos"].push(`\nTotal de Créditos: R$ ${formatarBR(creditos)}`);

                return creditos;
            }

            calcular_imposto_devido(dados, ano) {
                // Limpar memória de cálculo anterior
                this.memoria_calculo = {
                    "validacao": [],
                    "base_tributavel": [],
                    "aliquotas": [],
                    "cbs": [],
                    "ibs": [],
                    "creditos": [],
                    "imposto_devido": [],
                    "impostos_atuais": [],
                    "creditos_cruzados": [],
                    "total_devido": []
                };

                // Validar dados
                try {
                    this.validar_dados(dados);
                    this.memoria_calculo["validacao"].push("Dados validados com sucesso.");
                } catch (e) {
                    this.memoria_calculo["validacao"].push(`Erro de validação: ${e.toString()}`);
                    throw e;
                }

                // Calcular base tributável
                const base = this.calcular_base_tributavel(dados, ano);

                // Obter alíquotas efetivas para o setor
                const aliquotas = this.config.obterAliquotasEfetivas(dados["setor"], ano);

                this.memoria_calculo["aliquotas"].push(`Alíquotas para o setor ${dados["setor"]} em ${ano}:`);
                this.memoria_calculo["aliquotas"].push(`CBS: ${formatarBR(aliquotas['CBS'] * 100)}%`);
                this.memoria_calculo["aliquotas"].push(`IBS: ${formatarBR(aliquotas['IBS'] * 100)}%`);
                this.memoria_calculo["aliquotas"].push(`Total: ${formatarBR(aliquotas['total'] * 100)}%`);

                // Calcular CBS e IBS
                const cbs = base * aliquotas["CBS"];
                const ibs = base * aliquotas["IBS"];
                const imposto_bruto = cbs + ibs;

                this.memoria_calculo["cbs"].push(`Cálculo da CBS:`);
                this.memoria_calculo["cbs"].push(`Base tributável: R$ ${formatarBR(base)}`);
                this.memoria_calculo["cbs"].push(`Alíquota CBS: ${formatarBR(aliquotas['CBS'] * 100)}%`);
                this.memoria_calculo["cbs"].push(
                    `CBS = R$ ${formatarBR(base)} × ${formatarBR(aliquotas['CBS'] * 100)}% = R$ ${formatarBR(cbs)}`);

                this.memoria_calculo["ibs"].push(`Cálculo do IBS:`);
                this.memoria_calculo["ibs"].push(`Base tributável: R$ ${formatarBR(base)}`);
                this.memoria_calculo["ibs"].push(`Alíquota IBS: ${formatarBR(aliquotas['IBS'] * 100)}%`);
                this.memoria_calculo["ibs"].push(
                    `IBS = R$ ${formatarBR(base)} × ${formatarBR(aliquotas['IBS'] * 100)}% = R$ ${formatarBR(ibs)}`);

                this.memoria_calculo["imposto_devido"].push(`Imposto Bruto (CBS + IBS):`);
                this.memoria_calculo["imposto_devido"].push(
                    `Imposto Bruto = R$ ${formatarBR(cbs)} + R$ ${formatarBR(ibs)} = R$ ${formatarBR(imposto_bruto)}`);

                // Abordagem em duas etapas para o cálculo de créditos
                // 1. Primeiro calculamos os créditos que não dependem do imposto devido
                const dados_iniciais = Object.assign({}, dados);
                dados_iniciais["imposto_devido"] = imposto_bruto;  // Estimativa inicial
                const creditos = this.calcular_creditos(dados_iniciais, ano);

                // 2. Calcular o imposto devido final
                const imposto_devido = Math.max(0, imposto_bruto - creditos);

                this.memoria_calculo["imposto_devido"].push(`Cálculo do Imposto Devido:`);
                this.memoria_calculo["imposto_devido"].push(`Imposto Devido = Imposto Bruto - Créditos`);
                this.memoria_calculo["imposto_devido"].push(
                    `Imposto Devido = R$ ${formatarBR(imposto_bruto)} - R$ ${formatarBR(creditos)} = R$ ${formatarBR(imposto_devido)}`);

                // Calcular impostos do sistema atual
                if (!this.calculadora_atual) {
                    this.calculadora_atual = new CalculadoraTributosAtuais(this.config);
                }

                const impostos_atuais = this.calculadora_atual.calcular_todos_impostos(dados, ano);

                // Registrar memória de cálculo dos impostos atuais
                this.memoria_calculo["impostos_atuais"] = this.calculadora_atual.memoria_calculo;

                // Aplicar créditos cruzados se aplicável
                if (this.config.creditos_cruzados[ano]) {
                    this.memoria_calculo["creditos_cruzados"].push(`Aplicação de Créditos Cruzados (ano ${ano}):`);

                    const percentual_ibs_para_icms = this.config.creditos_cruzados[ano]["IBS_para_ICMS"] || 0;
                    this.memoria_calculo["creditos_cruzados"].push(
                        `Percentual do IBS aproveitável para ICMS: ${formatarBR(percentual_ibs_para_icms * 100)}%`);

                    const credito_ibs_para_icms = Math.min(
                        ibs * percentual_ibs_para_icms,
                        impostos_atuais["ICMS"] || 0
                    );

                    this.memoria_calculo["creditos_cruzados"].push(`Limite de crédito: min(IBS × Percentual, ICMS)`);
                    this.memoria_calculo["creditos_cruzados"].push(
                        `Limite de crédito: min(R$ ${formatarBR(ibs)} × ${formatarBR(percentual_ibs_para_icms * 100)}%, R$ ${formatarBR(impostos_atuais["ICMS"] || 0)})`);
                    this.memoria_calculo["creditos_cruzados"].push(
                        `Limite de crédito: min(R$ ${formatarBR(ibs * percentual_ibs_para_icms)}, R$ ${formatarBR(impostos_atuais["ICMS"] || 0)})`);
                    this.memoria_calculo["creditos_cruzados"].push(
                        `Crédito IBS para ICMS: R$ ${formatarBR(credito_ibs_para_icms)}`);

                    // Atualizar ICMS devido após crédito cruzado
                    const icms_original = impostos_atuais["ICMS"] || 0;
                    const icms_final = icms_original - credito_ibs_para_icms;

                    this.memoria_calculo["creditos_cruzados"].push(`ICMS original: R$ ${formatarBR(icms_original)}`);
                    this.memoria_calculo["creditos_cruzados"].push(
                        `ICMS final após crédito cruzado: R$ ${formatarBR(icms_original)} - R$ ${formatarBR(credito_ibs_para_icms)} = R$ ${formatarBR(icms_final)}`);

                    impostos_atuais["ICMS"] = icms_final;
                    impostos_atuais["total"] = impostos_atuais["PIS"] + impostos_atuais["COFINS"] + 
                                               impostos_atuais["ICMS"] + impostos_atuais["ISS"] + 
                                               impostos_atuais["IPI"];

                    this.memoria_calculo["creditos_cruzados"].push(
                        `Total de impostos atuais após crédito cruzado: R$ ${formatarBR(impostos_atuais["total"])}`);
                }

                // Cálculo do total devido
                const total_devido = imposto_devido + impostos_atuais["total"];

                this.memoria_calculo["total_devido"].push(`Cálculo do Total Devido:`);
                this.memoria_calculo["total_devido"].push(`Total Devido = Imposto Devido (IVA Dual) + Total Impostos Atuais`);
                this.memoria_calculo["total_devido"].push(
                    `Total Devido = R$ ${formatarBR(imposto_devido)} + R$ ${formatarBR(impostos_atuais["total"])} = R$ ${formatarBR(total_devido)}`);

                // Alíquota efetiva
                let aliquota_efetiva = 0;
                if (dados["faturamento"] > 0) {
                    aliquota_efetiva = total_devido / dados["faturamento"];
                    this.memoria_calculo["total_devido"].push(
                        `Alíquota Efetiva: R$ ${formatarBR(total_devido)} ÷ R$ ${formatarBR(dados["faturamento"])} = ${formatarBR(aliquota_efetiva * 100)}%`);
                } else {
                    this.memoria_calculo["total_devido"].push(`Alíquota Efetiva: 0% (faturamento zero)`);
                }

                // Resultado detalhado
                const resultado = {
                    "ano": ano,
                    "base_tributavel": base,
                    "cbs": cbs,
                    "ibs": ibs,
                    "imposto_bruto": imposto_bruto,
                    "creditos": creditos,
                    "imposto_devido": imposto_devido,
                    "impostos_atuais": impostos_atuais,
                    "total_devido": total_devido,
                    "aliquota_efetiva": aliquota_efetiva,
                    "aliquotas_utilizadas": aliquotas
                };

                return resultado;
            }

            obter_memoria_calculo() {
                return this.memoria_calculo;
            }

            calcular_comparativo(dados, anos = null) {
                if (anos === null) {
                    anos = Object.keys(this.config.fase_transicao).map(Number);
                }
                
                const resultados = {};
                for (const ano of anos) {
                    resultados[ano] = this.calcular_imposto_devido(dados, ano);
                }
                
                return resultados;
            }

            calcular_aliquotas_equivalentes(dados, carga_atual, ano) {
                // Fator de transição para o ano
                const fator_transicao = this.config.fase_transicao[ano] || 1.0;
                
                // Base tributável
                const base = this.calcular_base_tributavel(dados, ano);
                
                // Valor atual de impostos
                const valor_atual = dados["faturamento"] * (carga_atual / 100);
                
                // Considerando a proporção atual entre CBS e IBS (geralmente 1:2)
                let proporcao_cbs = 1/3;  // CBS representa aproximadamente 1/3 do IVA Dual
                
                // Adaptação para o setor específico
                const setor_config = this.config.setores_especiais[dados["setor"]] || this.config.setores_especiais["padrao"];
                const reducao_cbs = setor_config["reducao_CBS"];
                
                // Ajuste na proporção considerando reduções setoriais
                if (reducao_cbs > 0) {
                    // Se há redução de CBS, a proporção do IBS aumenta
                    proporcao_cbs = proporcao_cbs * (1 - reducao_cbs);
                }
                
                // Créditos estimados (simplificação)
                let creditos_estimados = 0;
                if (dados["custos_tributaveis"] > 0) {
                    // Estimativa: créditos proporcionais aos custos tributáveis
                    creditos_estimados = (dados["custos_tributaveis"] / dados["faturamento"]) * valor_atual;
                }
                
                // Imposto bruto necessário para atingir o valor atual após créditos
                const imposto_bruto_necessario = valor_atual + creditos_estimados;
                
                // Alíquotas equivalentes
                let aliquota_cbs = 0;
                let aliquota_ibs = 0;
                
                if (base > 0) {
                    const aliquota_total = imposto_bruto_necessario / base;
                    aliquota_cbs = aliquota_total * proporcao_cbs;
                    aliquota_ibs = aliquota_total * (1 - proporcao_cbs);
                }
                
                return {
                    "cbs_equivalente": aliquota_cbs,
                    "ibs_equivalente": aliquota_ibs,
                    "total_equivalente": aliquota_cbs + aliquota_ibs,
                    "valor_atual": valor_atual,
                    "base_calculo": base
                };
            }
        }
        
    
        // Parte 3: Lógica de Interface e Manipuladores de Eventos
        
        // Variáveis globais
        let configuracao;
        let calculadora;
        let resultados = {};
        let aliquotasEquivalentes = {};
        
        // Gerenciamento de abas
        function inicializarAbas() {
            const botoes = document.querySelectorAll('.tab-button');
            const conteudos = document.querySelectorAll('.tab-content');
            
            botoes.forEach(botao => {
                botao.addEventListener('click', () => {
                    const tabId = botao.getAttribute('data-tab');
                    
                    // Remover active de todos
                    botoes.forEach(b => b.classList.remove('active'));
                    conteudos.forEach(c => c.classList.remove('active'));
                    
                    // Adicionar active ao selecionado
                    botao.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }
        
        // Gerenciamento de abas de incentivos
        function inicializarAbasIncentivos() {
            const botoes = document.querySelectorAll('.incentivos-tab-button');
            const conteudos = document.querySelectorAll('.incentivos-tab-content');
            
            botoes.forEach(botao => {
                botao.addEventListener('click', () => {
                    const tabId = botao.getAttribute('data-incentivo-tab');
                    
                    // Remover active de todos
                    botoes.forEach(b => b.classList.remove('active'));
                    conteudos.forEach(c => c.classList.remove('active'));
                    
                    // Adicionar active ao selecionado
                    botao.classList.add('active');
                    document.getElementById(`incentivos-${tabId}`).classList.add('active');
                });
            });
        }
        
        // Funções de incentivos fiscais
        function adicionarIncentivo(tipo) {
            const modal = document.getElementById('modal-incentivo');
            modal.style.display = 'block';
            
            const titulo = document.getElementById('modal-titulo');
            if (tipo === 'saida') {
                titulo.textContent = 'Adicionar Incentivo de Saída';
            } else if (tipo === 'entrada') {
                titulo.textContent = 'Adicionar Incentivo de Entrada';
            } else if (tipo === 'apuracao') {
                titulo.textContent = 'Adicionar Incentivo de Apuração';
            }
            
            // Limpar campos do modal
            document.getElementById('modal-descricao').value = '';
            document.getElementById('modal-tipo').value = 'Nenhum';
            document.getElementById('modal-percentual').value = '';
            document.getElementById('modal-operacoes').value = '100';
            
            // Configurar tipos específicos para apuração
            const tipoSelect = document.getElementById('modal-tipo');
            tipoSelect.innerHTML = ''; // Limpar opções
            
            const tiposIncentivo = tipo === 'apuracao' 
                ? ['Nenhum', 'Crédito Presumido/Outorgado', 'Redução do Saldo Devedor']
                : ['Nenhum', 'Redução de Alíquota', 'Crédito Presumido/Outorgado', 'Redução de Base de Cálculo', 'Diferimento'];
            
            if (tipo === 'entrada') {
                tiposIncentivo.push('Estorno de Crédito');
            }
            
            tiposIncentivo.forEach(t => {
                const option = document.createElement('option');
                option.value = t;
                option.textContent = t;
                tipoSelect.appendChild(option);
            });
            
            // Configurar label correta para operações
            const operacoesLabel = document.querySelector('label[for="modal-operacoes"]');
            if (tipo === 'apuracao') {
                operacoesLabel.textContent = '% do Saldo:';
            } else {
                operacoesLabel.textContent = '% Operações Abrangidas:';
            }
            
            // Configurar evento de salvar
            const salvarBtn = document.getElementById('modal-salvar');
            const cancelarBtn = document.getElementById('modal-cancelar');
            const closeBtn = document.querySelector('.close');
            
            salvarBtn.onclick = () => salvarIncentivo(tipo);
            cancelarBtn.onclick = () => modal.style.display = 'none';
            closeBtn.onclick = () => modal.style.display = 'none';
            
            // Fechar modal ao clicar fora
            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            }
        }
        
        function salvarIncentivo(tipo) {
            const descricao = document.getElementById('modal-descricao').value || `Incentivo ${tipo}`;
            const tipoIncentivo = document.getElementById('modal-tipo').value;
            const percentual = parseFloat(document.getElementById('modal-percentual').value) || 0;
            const percOperacoes = parseFloat(document.getElementById('modal-operacoes').value) || 100;
            
            // Validações
            if (tipoIncentivo !== 'Nenhum' && percentual <= 0) {
                alert('O percentual do incentivo deve ser maior que zero.');
                return;
            }
            
            // Validar total de operações incentivadas
            if (tipo !== 'apuracao') {
                const tabela = document.getElementById(`tabela-incentivos-${tipo}`).querySelector('tbody');
                let totalPercentual = percOperacoes;
                
                for (let row of tabela.rows) {
                    totalPercentual += parseFloat(row.cells[3].textContent.replace('%', ''));
                }
                
                if (totalPercentual > 100) {
                    alert(`O total de operações incentivadas (${formatarBR(totalPercentual)}%) excede 100%. Ajuste os percentuais.`);
                    return;
                }
            }
            
            // Adicionar à tabela
            const tabela = document.getElementById(`tabela-incentivos-${tipo}`).querySelector('tbody');
            const row = tabela.insertRow();
            
            // Células de dados
            row.insertCell(0).textContent = descricao;
            row.insertCell(1).textContent = tipoIncentivo;
            row.insertCell(2).textContent = `${percentual}%`;
            row.insertCell(3).textContent = `${percOperacoes}%`;
            
            // Célula de ações
            const acoesCell = row.insertCell(4);
            const editBtn = document.createElement('button');
            editBtn.textContent = 'Editar';
            editBtn.onclick = () => editarIncentivo(tipo, row);
            
            const removeBtn = document.createElement('button');
            removeBtn.textContent = 'Remover';
            removeBtn.onclick = () => confirmarRemocao(row, descricao);
            
            acoesCell.appendChild(editBtn);
            acoesCell.appendChild(removeBtn);
            
            // Fechar modal
            document.getElementById('modal-incentivo').style.display = 'none';
        }
        
        function editarIncentivo(tipo, row) {
            const modal = document.getElementById('modal-incentivo');
            modal.style.display = 'block';
            
            const titulo = document.getElementById('modal-titulo');
            if (tipo === 'saida') {
                titulo.textContent = 'Editar Incentivo de Saída';
            } else if (tipo === 'entrada') {
                titulo.textContent = 'Editar Incentivo de Entrada';
            } else if (tipo === 'apuracao') {
                titulo.textContent = 'Editar Incentivo de Apuração';
            }
            
            // Preencher campos com valores atuais
            document.getElementById('modal-descricao').value = row.cells[0].textContent;
            document.getElementById('modal-tipo').value = row.cells[1].textContent;
            document.getElementById('modal-percentual').value = parseFloat(row.cells[2].textContent.replace('%', ''));
            document.getElementById('modal-operacoes').value = parseFloat(row.cells[3].textContent.replace('%', ''));
            
            // Configurar tipos específicos para apuração
            const tipoSelect = document.getElementById('modal-tipo');
            tipoSelect.innerHTML = ''; // Limpar opções
            
            const tiposIncentivo = tipo === 'apuracao' 
                ? ['Nenhum', 'Crédito Presumido/Outorgado', 'Redução do Saldo Devedor']
                : ['Nenhum', 'Redução de Alíquota', 'Crédito Presumido/Outorgado', 'Redução de Base de Cálculo', 'Diferimento'];
            
            if (tipo === 'entrada') {
                tiposIncentivo.push('Estorno de Crédito');
            }
            
            tiposIncentivo.forEach(t => {
                const option = document.createElement('option');
                option.value = t;
                option.textContent = t;
                if (t === row.cells[1].textContent) {
                    option.selected = true;
                }
                tipoSelect.appendChild(option);
            });
            
            // Configurar label correta para operações
            const operacoesLabel = document.querySelector('label[for="modal-operacoes"]');
            if (tipo === 'apuracao') {
                operacoesLabel.textContent = '% do Saldo:';
            } else {
                operacoesLabel.textContent = '% Operações Abrangidas:';
            }
            
            // Configurar evento de salvar
            const salvarBtn = document.getElementById('modal-salvar');
            const cancelarBtn = document.getElementById('modal-cancelar');
            const closeBtn = document.querySelector('.close');
            
            salvarBtn.onclick = () => {
                const descricao = document.getElementById('modal-descricao').value || `Incentivo ${tipo}`;
                const tipoIncentivo = document.getElementById('modal-tipo').value;
                const percentual = parseFloat(document.getElementById('modal-percentual').value) || 0;
                const percOperacoes = parseFloat(document.getElementById('modal-operacoes').value) || 100;
                
                // Validações
                if (tipoIncentivo !== 'Nenhum' && percentual <= 0) {
                    alert('O percentual do incentivo deve ser maior que zero.');
                    return;
                }
                
                // Validar total de operações incentivadas
                if (tipo !== 'apuracao') {
                    const tabela = document.getElementById(`tabela-incentivos-${tipo}`).querySelector('tbody');
                    let totalPercentual = percOperacoes;
                    
                    for (let r of tabela.rows) {
                        if (r !== row) { // Excluir a linha sendo editada
                            totalPercentual += parseFloat(r.cells[3].textContent.replace('%', ''));
                        }
                    }
                    
                    if (totalPercentual > 100) {
                        alert(`O total de operações incentivadas (${formatarBR(totalPercentual)}%) excede 100%. Ajuste os percentuais.`);
                        return;
                    }
                }
                
                // Atualizar valores na tabela
                row.cells[0].textContent = descricao;
                row.cells[1].textContent = tipoIncentivo;
                row.cells[2].textContent = `${percentual}%`;
                row.cells[3].textContent = `${percOperacoes}%`;
                
                // Fechar modal
                modal.style.display = 'none';
            };
            
            cancelarBtn.onclick = () => modal.style.display = 'none';
            closeBtn.onclick = () => modal.style.display = 'none';
        }
        
        function confirmarRemocao(row, descricao) {
            if (confirm(`Deseja remover o incentivo '${descricao}'?`)) {
                row.parentNode.removeChild(row);
            }
        }
        
        // Função principal de simulação
        function executarSimulacao() {
            try {
                // Coletar dados da empresa
                const dadosEmpresa = {
                    "faturamento": obterValorNumerico(document.getElementById('faturamento')),
                    "custos_tributaveis": obterValorNumerico(document.getElementById('custos')),
                    "custos_icms": obterValorNumerico(document.getElementById('custos_icms')),
                    "custos_simples": obterValorNumerico(document.getElementById('custos_simples')),
                    "creditos_anteriores": obterValorNumerico(document.getElementById('creditos_anteriores')),
                    "setor": document.getElementById('setor').value,
                    "regime": document.getElementById('regime').value,
                    "imposto_devido": 0
                };
                
                // Atualizar configurações do ICMS
                configuracao.icms_config = {
                    "aliquota_entrada": parseFloat(document.getElementById('aliquota_entrada').value) / 100,
                    "aliquota_saida": parseFloat(document.getElementById('aliquota_saida').value) / 100,
                    "incentivos_saida": [],
                    "incentivos_entrada": [],
                    "incentivos_apuracao": []
                };
                
                // Construir lista de incentivos
                construirListaIncentivos('saida');
                construirListaIncentivos('entrada');
                construirListaIncentivos('apuracao');
                
                // Obter carga tributária atual
                const carga_atual = parseFloat(document.getElementById('carga_atual').value);
                
                // Definir anos para simulação
                const ano_inicial = parseInt(document.getElementById('ano_inicial').value);
                const ano_final = parseInt(document.getElementById('ano_final').value);
                const anos = [];
                for (let ano = ano_inicial; ano <= ano_final; ano++) {
                    anos.push(ano);
                }
                
                // Executar simulação
                resultados = calculadora.calcular_comparativo(dadosEmpresa, anos);
                
                // Calcular alíquotas equivalentes para cada ano
                aliquotasEquivalentes = {};
                for (const ano of anos) {
                    aliquotasEquivalentes[ano] = calculadora.calcular_aliquotas_equivalentes(
                        dadosEmpresa, carga_atual, ano
                    );
                }
                
                // Atualizar tabela
                atualizarTabelaResultados();
                
                // Atualizar gráficos
                atualizarGraficos();
                
                // Atualizar memória de cálculo
                atualizarComboAnosMemoria();
                atualizarMemoriaCalculo();
                
                alert('Simulação concluída com sucesso!');
                
            } catch (error) {
                alert(`Ocorreu um erro durante a simulação: ${error.message}`);
                console.error(error);
            }
        }
        
        function construirListaIncentivos(tipo) {
            const tabela = document.getElementById(`tabela-incentivos-${tipo}`).querySelector('tbody');
            const incentivos = [];
            
            for (let row of tabela.rows) {
                const descricao = row.cells[0].textContent;
                const tipoIncentivo = row.cells[1].textContent;
                const percentual = parseFloat(row.cells[2].textContent.replace('%', '')) / 100;
                const percOperacoes = parseFloat(row.cells[3].textContent.replace('%', '')) / 100;
                
                const incentivo = {
                    "descricao": descricao,
                    "tipo": tipoIncentivo,
                    "percentual": percentual,
                    "percentual_operacoes": percOperacoes,
                    "aplicavel_saidas": tipo === 'saida',
                    "aplicavel_entradas": tipo === 'entrada',
                    "aplicavel_apuracao": tipo === 'apuracao'
                };
                
                if (tipo === 'saida') {
                    configuracao.icms_config.incentivos_saida.push(incentivo);
                } else if (tipo === 'entrada') {
                    configuracao.icms_config.incentivos_entrada.push(incentivo);
                } else if (tipo === 'apuracao') {
                    configuracao.icms_config.incentivos_apuracao.push(incentivo);
                }
            }
        }
        
        function atualizarTabelaResultados() {
            const tabela = document.getElementById('tabela-resultados').querySelector('tbody');
            tabela.innerHTML = ''; // Limpar tabela
            
            for (const [ano, resultado] of Object.entries(resultados)) {
                const row = tabela.insertRow();
                
                // Cálculos para a tabela
                const subtotalNovo = resultado.cbs + resultado.ibs;
                const pisCofins = resultado.impostos_atuais.PIS + resultado.impostos_atuais.COFINS;
                const issIpi = resultado.impostos_atuais.ISS + resultado.impostos_atuais.IPI;
                const subtotalAtual = pisCofins + resultado.impostos_atuais.ICMS + issIpi;
                const total = resultado.total_devido;
                
                // Obter carga atual
                const valorAtual = aliquotasEquivalentes[ano].valor_atual;
                const variacaoCarga = ((total - valorAtual) / valorAtual) * 100;
                
                // Preencher células
                row.insertCell(0).textContent = ano;
                row.insertCell(1).textContent = `R$ ${formatarBR(resultado.cbs)}`;
                row.insertCell(2).textContent = `R$ ${formatarBR(resultado.ibs)}`;
                row.insertCell(3).textContent = `R$ ${formatarBR(subtotalNovo)}`;
                row.insertCell(4).textContent = `R$ ${formatarBR(pisCofins)}`;
                row.insertCell(5).textContent = `R$ ${formatarBR(resultado.impostos_atuais.ICMS)}`;
                row.insertCell(6).textContent = `R$ ${formatarBR(issIpi)}`;
                row.insertCell(7).textContent = `R$ ${formatarBR(subtotalAtual)}`;
                row.insertCell(8).textContent = `R$ ${formatarBR(total)}`;
                
                const varCell = row.insertCell(9);
                varCell.textContent = `${formatarBR(variacaoCarga)}%`;
                varCell.className = variacaoCarga > 0 ? 'negative-value' : 'positive-value';
            }
        }
        
        function atualizarGraficos() {
            // Os gráficos serão implementados na parte 4
            console.log('Atualização de gráficos será implementada na parte 4');
        }
        
        function atualizarComboAnosMemoria() {
            const combo = document.getElementById('select-ano-memoria');
            combo.innerHTML = '';
            
            for (const ano of Object.keys(resultados)) {
                const option = document.createElement('option');
                option.value = ano;
                option.textContent = ano;
                combo.appendChild(option);
            }
        }
        
        function atualizarMemoriaCalculo() {
            const anoSelecionado = parseInt(document.getElementById('select-ano-memoria').value);
            if (!anoSelecionado || !resultados[anoSelecionado]) {
                document.getElementById('memoria-calculo').textContent = 'Não há dados disponíveis. Execute uma simulação primeiro.';
                return;
            }
            
            // Obter a memória de cálculo
            const memoria = calculadora.obter_memoria_calculo();
            
            // Formatar a memória de cálculo para exibição
            let texto = `=== MEMÓRIA DE CÁLCULO - ANO ${anoSelecionado} ===\n\n`;
            
            // Validação de dados
            texto += '=== VALIDAÇÃO DE DADOS ===\n';
            for (const linha of memoria.validacao || []) {
                texto += `${linha}\n`;
            }
            texto += '\n';
            
            // Base tributável
            texto += '=== BASE TRIBUTÁVEL ===\n';
            for (const linha of memoria.base_tributavel || []) {
                texto += `${linha}\n`;
            }
            texto += '\n';
            
            // Alíquotas
            texto += '=== ALÍQUOTAS ===\n';
            for (const linha of memoria.aliquotas || []) {
                texto += `${linha}\n`;
            }
            texto += '\n';
            
            // CBS
            texto += '=== CÁLCULO DA CBS ===\n';
            for (const linha of memoria.cbs || []) {
                texto += `${linha}\n`;
            }
            texto += '\n';
            
            // IBS
            texto += '=== CÁLCULO DO IBS ===\n';
            for (const linha of memoria.ibs || []) {
                texto += `${linha}\n`;
            }
            texto += '\n';
            
            // Créditos
            texto += '=== CÁLCULO DOS CRÉDITOS ===\n';
            for (const linha of memoria.creditos || []) {
                texto += `${linha}\n`;
            }
            texto += '\n';
            
            // Imposto devido
            texto += '=== CÁLCULO DO IMPOSTO DEVIDO ===\n';
            for (const linha of memoria.imposto_devido || []) {
                texto += `${linha}\n`;
            }
            texto += '\n';
            
            // Impostos Atuais
            texto += '=== CÁLCULO DOS IMPOSTOS ATUAIS ===\n';
            
            // PIS
            texto += '\n--- PIS ---\n';
            for (const linha of (memoria.impostos_atuais?.PIS || [])) {
                texto += `${linha}\n`;
            }
            
            // COFINS
            texto += '\n--- COFINS ---\n';
            for (const linha of (memoria.impostos_atuais?.COFINS || [])) {
                texto += `${linha}\n`;
            }
            
            // ICMS
            texto += '\n--- ICMS ---\n';
            for (const linha of (memoria.impostos_atuais?.ICMS || [])) {
                texto += `${linha}\n`;
            }
            
            // ISS
            texto += '\n--- ISS ---\n';
            for (const linha of (memoria.impostos_atuais?.ISS || [])) {
                texto += `${linha}\n`;
            }
            
            // IPI
            texto += '\n--- IPI ---\n';
            for (const linha of (memoria.impostos_atuais?.IPI || [])) {
                texto += `${linha}\n`;
            }
            
            // Total Impostos Atuais
            texto += '\n--- TOTAL IMPOSTOS ATUAIS ---\n';
            for (const linha of (memoria.impostos_atuais?.total || [])) {
                texto += `${linha}\n`;
            }
            texto += '\n';
            
            // Créditos Cruzados
            if (memoria.creditos_cruzados && memoria.creditos_cruzados.length > 0) {
                texto += '=== CRÉDITOS CRUZADOS ===\n';
                for (const linha of memoria.creditos_cruzados) {
                    texto += `${linha}\n`;
                }
                texto += '\n';
            }
            
            // Total Devido
            texto += '=== TOTAL DEVIDO ===\n';
            for (const linha of (memoria.total_devido || [])) {
                texto += `${linha}\n`;
            }
            
            // Exibir a memória de cálculo
            document.getElementById('memoria-calculo').textContent = texto;
        }
        
        // Funções de configuração
        function salvarConfiguracoes() {
            try {
                // Atualizar configurações com os valores dos campos
                configuracao.aliquotas_base.CBS = parseFloat(document.getElementById('config-cbs').value) / 100;
                configuracao.aliquotas_base.IBS = parseFloat(document.getElementById('config-ibs').value) / 100;
                
                // Atualizar fases de transição
                const inputsFases = document.querySelectorAll('#tabela-fases input');
                inputsFases.forEach(input => {
                    const ano = parseInt(input.getAttribute('data-ano'));
                    configuracao.fase_transicao[ano] = parseFloat(input.value) / 100;
                });
                
                // Atualizar setores especiais
                const inputsSetores = document.querySelectorAll('#tabela-setores input');
                inputsSetores.forEach(input => {
                    const setor = input.getAttribute('data-setor');
                    const campo = input.getAttribute('data-campo');
                    
                    if (campo === 'ibs') {
                        configuracao.setores_especiais[setor].IBS = parseFloat(input.value) / 100;
                    } else if (campo === 'reducao') {
                        configuracao.setores_especiais[setor].reducao_CBS = parseFloat(input.value) / 100;
                    }
                });
                
                // Salvar em localStorage
                localStorage.setItem('configuracao_tributaria', JSON.stringify(configuracao));
                
                alert('Configurações salvas com sucesso!');
            } catch (error) {
                alert(`Erro ao salvar configurações: ${error.message}`);
            }
        }
        
        function carregarConfiguracoes() {
            try {
                const configSalva = localStorage.getItem('configuracao_tributaria');
                if (configSalva) {
                    configuracao.carregarConfiguracoes(JSON.parse(configSalva));
                    
                    // Atualizar campos com as configurações carregadas
                    document.getElementById('config-cbs').value = configuracao.aliquotas_base.CBS * 100;
                    document.getElementById('config-ibs').value = configuracao.aliquotas_base.IBS * 100;
                    
                    // Atualizar campos de fases
                    for (const [ano, percentual] of Object.entries(configuracao.fase_transicao)) {
                        const input = document.querySelector(`#tabela-fases input[data-ano="${ano}"]`);
                        if (input) {
                            input.value = percentual * 100;
                        }
                    }
                    
                    // Atualizar campos de setores
                    for (const [setor, valores] of Object.entries(configuracao.setores_especiais)) {
                        const inputIBS = document.querySelector(`#tabela-setores input[data-setor="${setor}"][data-campo="ibs"]`);
                        const inputReducao = document.querySelector(`#tabela-setores input[data-setor="${setor}"][data-campo="reducao"]`);
                        
                        if (inputIBS) inputIBS.value = valores.IBS * 100;
                        if (inputReducao) inputReducao.value = valores.reducao_CBS * 100;
                    }
                    
                    alert('Configurações carregadas com sucesso!');
                } else {
                    alert('Não há configurações salvas.');
                }
            } catch (error) {
                alert(`Erro ao carregar configurações: ${error.message}`);
            }
        }
        
        function restaurarConfiguracoes() {
            try {
                // Criar nova instância de configuração
                configuracao = new ConfiguracaoTributaria();
                calculadora = new CalculadoraIVADual(configuracao);
                
                // Atualizar campos com as configurações padrão
                document.getElementById('config-cbs').value = configuracao.aliquotas_base.CBS * 100;
                document.getElementById('config-ibs').value = configuracao.aliquotas_base.IBS * 100;
                
                // Atualizar campos de fases
                for (const [ano, percentual] of Object.entries(configuracao.fase_transicao)) {
                    const input = document.querySelector(`#tabela-fases input[data-ano="${ano}"]`);
                    if (input) {
                        input.value = percentual * 100;
                    }
                }
                
                // Atualizar campos de setores
                for (const [setor, valores] of Object.entries(configuracao.setores_especiais)) {
                    const inputIBS = document.querySelector(`#tabela-setores input[data-setor="${setor}"][data-campo="ibs"]`);
                    const inputReducao = document.querySelector(`#tabela-setores input[data-setor="${setor}"][data-campo="reducao"]`);
                    
                    if (inputIBS) inputIBS.value = valores.IBS * 100;
                    if (inputReducao) inputReducao.value = valores.reducao_CBS * 100;
                }
                
                alert('Configurações restauradas para os valores padrão.');
            } catch (error) {
                alert(`Erro ao restaurar configurações: ${error.message}`);
            }
        }
        
        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar classes
            configuracao = new ConfiguracaoTributaria();
            calculadora = new CalculadoraIVADual(configuracao);
            
            // Inicializar abas
            inicializarAbas();
            inicializarAbasIncentivos();
            
            // Adicionar event listeners para botões
            document.getElementById('btn-simular').addEventListener('click', executarSimulacao);
            document.getElementById('btn-atualizar-memoria').addEventListener('click', atualizarMemoriaCalculo);
            document.getElementById('btn-salvar-config').addEventListener('click', salvarConfiguracoes);
            document.getElementById('btn-carregar-config').addEventListener('click', carregarConfiguracoes);
            document.getElementById('btn-restaurar-config').addEventListener('click', restaurarConfiguracoes);
            
            // Adicionar event listeners para exportação (serão implementados na parte 5)
            document.getElementById('btn-exportar-pdf').addEventListener('click', function() {
                console.log('Exportação para PDF será implementada na parte 5');
            });
            
            document.getElementById('btn-exportar-excel').addEventListener('click', function() {
                console.log('Exportação para Excel será implementada na parte 5');
            });
            
            document.getElementById('btn-exportar-memoria').addEventListener('click', function() {
                const texto = document.getElementById('memoria-calculo').textContent;
                const blob = new Blob([texto], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `memoria_calculo_${new Date().toISOString()}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            });

            // Adicionar máscara de moeda nos campos de valor
            const camposMoeda = [
                'faturamento',
                'custos',
                'custos_icms',
                'custos_simples',
                'creditos_anteriores'
            ];

            camposMoeda.forEach(campoId => {
                const campo = document.getElementById(campoId);
                if (campo) {
                    // Formatar o valor inicial
                    if (campo.value === '0') {
                        campo.value = 'R$ 0,00';
                    }
                    
                    campo.addEventListener('keyup', function() {
                        formatarMoeda(this);
                    });
                    
                    // Ao sair do campo, garantir formatação
                    campo.addEventListener('blur', function() {
                        if (!this.value) {
                            this.value = 'R$ 0,00';
                        }
                    });
                }
            });
            
            // Carregar configurações se existirem
            const configSalva = localStorage.getItem('configuracao_tributaria');
            if (configSalva) {
                configuracao.carregarConfiguracoes(JSON.parse(configSalva));
            }
        });
       
    // Parte 4: Implementação dos Gráficos
        
        let graficoComparativo = null;
        let graficoAliquotas = null;
        let graficoTransicao = null;
        let graficoIncentivos = null;
        
        function destruirGraficos() {
            if (graficoComparativo) {
                graficoComparativo.destroy();
                graficoComparativo = null;
            }
            if (graficoAliquotas) {
                graficoAliquotas.destroy();
                graficoAliquotas = null;
            }
            if (graficoTransicao) {
                graficoTransicao.destroy();
                graficoTransicao = null;
            }
            if (graficoIncentivos) {
                graficoIncentivos.destroy();
                graficoIncentivos = null;
            }
        }
        
        function atualizarGraficos() {
            destruirGraficos();
            
            // Gráfico Comparativo
            plotarGraficoComparativo();
            
            // Gráfico de Alíquotas Efetivas
            plotarGraficoAliquotas();
            
            // Gráfico de Transição
            plotarGraficoTransicao();
            
            // Gráfico de Incentivos
            plotarGraficoIncentivos();
        }
        
        function plotarGraficoComparativo() {
            const ctx = document.getElementById('grafico-comparativo').getContext('2d');
            const anos = Object.keys(resultados).sort();
            
            const datasets = [
                {
                    label: 'CBS',
                    data: anos.map(ano => resultados[ano].cbs),
                    backgroundColor: '#3498db',
                    borderColor: '#3498db',
                    borderWidth: 1
                },
                {
                    label: 'IBS',
                    data: anos.map(ano => resultados[ano].ibs),
                    backgroundColor: '#2ecc71',
                    borderColor: '#2ecc71',
                    borderWidth: 1
                },
                {
                    label: 'Créditos',
                    data: anos.map(ano => resultados[ano].creditos),
                    backgroundColor: '#e74c3c',
                    borderColor: '#e74c3c',
                    borderWidth: 1
                },
                {
                    label: 'Imposto Devido',
                    data: anos.map(ano => resultados[ano].imposto_devido),
                    backgroundColor: '#f39c12',
                    borderColor: '#f39c12',
                    borderWidth: 1
                }
            ];
            
            graficoComparativo = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: anos,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Comparativo de Impostos por Ano',
                            font: { size: 16 }
                        },
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += 'R$ ' + formatarBR(context.parsed.y);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Ano'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Valor (R$)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + formatarBR(value);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function plotarGraficoAliquotas() {
            const ctx = document.getElementById('grafico-aliquotas').getContext('2d');
            const anos = Object.keys(resultados).sort();
            
            const data = anos.map(ano => resultados[ano].aliquota_efetiva * 100);
            
            graficoAliquotas = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: anos,
                    datasets: [{
                        label: 'Alíquota Efetiva',
                        data: data,
                        borderColor: '#9b59b6',
                        backgroundColor: 'rgba(155, 89, 182, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.1,
                        pointRadius: 8,
                        pointBackgroundColor: '#9b59b6',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointHoverRadius: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Evolução da Alíquota Efetiva',
                            font: { size: 16 }
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Alíquota: ' + formatarBR(context.parsed.y) + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Ano'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Alíquota Efetiva (%)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatarBR(value) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function plotarGraficoTransicao() {
            const ctx = document.getElementById('grafico-transicao').getContext('2d');
            const anos = Object.keys(resultados).sort();
            
            // Preparar dados para o gráfico
            const dadosIVA = anos.map(ano => resultados[ano].imposto_devido);
            const dadosAtuais = anos.map(ano => {
                const impostos = resultados[ano].impostos_atuais;
                return impostos.total || 0;
            });
            
            graficoTransicao = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: anos,
                    datasets: [
                        {
                            label: 'Sistema Atual',
                            data: dadosAtuais,
                            backgroundColor: '#e74c3c',
                            borderColor: '#e74c3c',
                            borderWidth: 1
                        },
                        {
                            label: 'IVA Dual',
                            data: dadosIVA,
                            backgroundColor: '#3498db',
                            borderColor: '#3498db',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Evolução Tributária na Transição',
                            font: { size: 16 }
                        },
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += 'R$ ' + formatarBR(context.parsed.y);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Ano'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Valor (R$)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + formatarBR(value);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function plotarGraficoIncentivos() {
            const ctx = document.getElementById('grafico-incentivos').getContext('2d');
            
            if (!resultados || Object.keys(resultados).length === 0) {
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Sem dados para visualização', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            const anos = Object.keys(resultados).sort();
            
            // Preparar dados para o gráfico
            const icmsNormal = [];
            const icmsIncentivado = [];
            const economia = [];
            
            anos.forEach(ano => {
                const resultado = resultados[ano];
                const icmsDevido = resultado.impostos_atuais.ICMS || 0;
                const economiaIcms = resultado.impostos_atuais.economia_icms || 0;
                
                icmsNormal.push(icmsDevido + economiaIcms);
                icmsIncentivado.push(icmsDevido);
                economia.push(economiaIcms);
            });
            
            graficoIncentivos = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: anos,
                    datasets: [
                        {
                            label: 'ICMS sem Incentivo',
                            data: icmsNormal,
                            backgroundColor: '#e74c3c',
                            borderColor: '#e74c3c',
                            borderWidth: 1
                        },
                        {
                            label: 'ICMS com Incentivo',
                            data: icmsIncentivado,
                            backgroundColor: '#2ecc71',
                            borderColor: '#2ecc71',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Impacto dos Incentivos Fiscais no ICMS',
                            font: { size: 16 }
                        },
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += 'R$ ' + formatarBR(context.parsed.y);
                                    return label;
                                },
                                afterBody: function(tooltipItems) {
                                    const dataIndex = tooltipItems[0].dataIndex;
                                    const economiaValor = economia[dataIndex];
                                    return `Economia: R$ ${formatarBR(economiaValor)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Ano'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Valor (R$)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + formatarBR(value);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Funções de exportação (início da implementação)
        
        function exportarParaPDF() {
            if (typeof jspdf === 'undefined' || !jspdf.jsPDF) {
                alert('Biblioteca jsPDF não carregada. Por favor, aguarde e tente novamente.');
                return;
            }
            const { jsPDF } = jspdf;
            
            if (!resultados || Object.keys(resultados).length === 0) {
                alert('Execute uma simulação antes de exportar os resultados.');
                return;
            }
             // Solicita o nome do arquivo ao usuário
            const nomeArquivo = solicitarNomeArquivo('pdf', 'simulacao-reforma-tributaria');
            if (!nomeArquivo) {
                return; // Usuário cancelou
            }
            try {
                // Criar documento PDF
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                // Adicionar título
                doc.setFontSize(18);
                doc.text('Relatório de Simulação - IVA Dual (CBS/IBS)', 15, 15);
                
                // Data do relatório
                doc.setFontSize(10);
                const dataHora = new Date().toLocaleString('pt-BR');
                doc.text(`Data do relatório: ${dataHora}`, 15, 25);
                
                // Parâmetros da simulação
                doc.setFontSize(14);
                doc.text('Parâmetros da Simulação', 15, 35);
                
                doc.setFontSize(10);
                let y = 45;
                
                // Dados da empresa
                // Atualizar estas linhas na função exportarParaPDF:

                const parametrosBasicos = [
                        ['Faturamento Anual', `R$ ${formatarBR(obterValorNumerico(document.getElementById('faturamento').value))}`],
                        ['Custos Tributáveis (PIS/COFINS/IVA/CBS)', `R$ ${formatarBR(obterValorNumerico(document.getElementById('custos').value))}`],
                        ['Custos Tributáveis (ICMS)', `R$ ${formatarBR(obterValorNumerico(document.getElementById('custos_icms').value))}`],
                        ['Fornecedores do Simples', `R$ ${formatarBR(obterValorNumerico(document.getElementById('custos_simples').value))}`],
                        ['Créditos Anteriores', `R$ ${formatarBR(obterValorNumerico(document.getElementById('creditos_anteriores').value))}`],
                        ['Setor de Atividade', document.getElementById('setor').value],
                        ['Regime Tributário', document.getElementById('regime').value],
                        ['Carga Tributária Atual', `${document.getElementById('carga_atual').value}%`],
                        ['Ano Inicial', document.getElementById('ano_inicial').value],
                        ['Ano Final', document.getElementById('ano_final').value]
                    ];
                
                parametros.forEach(([label, value]) => {
                    doc.text(`${label}: ${value}`, 15, y);
                    y += 7;
                });
                
                // Resultados da simulação
                doc.setFontSize(14);
                doc.text('Resultados da Simulação', 15, y + 10);
                
                // Tabela de resultados
                const anos = Object.keys(resultados).sort();
                const tableData = anos.map(ano => {
                    const resultado = resultados[ano];
                    const valorAtual = aliquotasEquivalentes[ano].valor_atual;
                    const diferenca = resultado.imposto_devido - valorAtual;
                    
                    return [
                        ano,
                        formatarBR(resultado.cbs),
                        formatarBR(resultado.ibs),
                        formatarBR(resultado.imposto_bruto),
                        formatarBR(resultado.creditos),
                        formatarBR(resultado.imposto_devido),
                        formatarBR(valorAtual),
                        formatarBR(diferenca),
                        formatarBR(resultado.aliquota_efetiva * 100) + '%'
                    ];
                });
                
                // Adicionar tabela usando autoTable (se disponível) ou implementação manual
                doc.autoTable({
                    head: [['Ano', 'CBS (R$)', 'IBS (R$)', 'Imposto Bruto (R$)', 'Créditos (R$)', 
                            'Imposto Devido (R$)', 'Carga Atual (R$)', 'Diferença (R$)', 'Alíquota Efetiva (%)']],
                    body: tableData,
                    startY: y + 20,
                    theme: 'grid',
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [52, 152, 219] }
                });
                
                // Adicionar rodapé
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.text('© 2025 Expertzy Inteligência Tributária', 
                             doc.internal.pageSize.width / 2, 
                             doc.internal.pageSize.height - 10, 
                             { align: 'center' });
                }
                
                // Salvar o arquivo
                doc.save(`simulacao-reforma-tributaria-${new Date().toISOString()}.pdf`);
                
            } catch (error) {
                alert(`Erro ao exportar para PDF: ${error.message}`);
                console.error(error);
            }
        }
        
        function exportarParaExcel() {
            if (!XLSX) {
                alert('Biblioteca XLSX não carregada. Por favor, aguarde e tente novamente.');
                return;
            }
            
            if (!resultados || Object.keys(resultados).length === 0) {
                alert('Execute uma simulação antes de exportar os resultados.');
                return;
            }
            // Solicita o nome do arquivo ao usuário
            const nomeArquivo = solicitarNomeArquivo('xlsx', 'simulacao-reforma-tributaria');
            if (!nomeArquivo) {
                return; // Usuário cancelou
            }
            try {
                // Criar workbook
                const wb = XLSX.utils.book_new();
                
                // Aba de Parâmetros
                const parametros = [
                    ['Simulador da Reforma Tributária - IVA Dual (CBS/IBS)'],
                    ['Data do relatório', new Date().toLocaleString('pt-BR')],
                    [],
                    ['Parâmetro', 'Valor'],
                    ['Faturamento Anual', `R$ ${formatarBR(obterValorNumerico(document.getElementById('faturamento')))}`],
                    ['Custos Tributáveis', `R$ ${formatarBR(obterValorNumerico(document.getElementById('custos')))}`],
                    ['Fornecedores do Simples', `R$ ${formatarBR(obterValorNumerico(document.getElementById('custos_simples')))}`],
                    ['Créditos Anteriores', `R$ ${formatarBR(obterValorNumerico(document.getElementById('creditos_anteriores')))}`],
                    ['Setor de Atividade', document.getElementById('setor').value],
                    ['Regime Tributário', document.getElementById('regime').value],
                    ['Carga Tributária Atual', `${document.getElementById('carga_atual').value}%`],
                    ['Ano Inicial', document.getElementById('ano_inicial').value],
                    ['Ano Final', document.getElementById('ano_final').value]
                ];
                
                const wsParametros = XLSX.utils.aoa_to_sheet(parametros);
                XLSX.utils.book_append_sheet(wb, wsParametros, 'Parâmetros');
                
                // Aba de Resultados
                const anos = Object.keys(resultados).sort();
                const resultadosData = [
                    ['Resultados da Simulação'],
                    [],
                    ['Ano', 'CBS (R$)', 'IBS (R$)', 'Imposto Bruto (R$)', 'Créditos (R$)', 
                     'Imposto Devido (R$)', 'Carga Atual (R$)', 'Diferença (R$)', 'Alíquota Efetiva (%)']
                ];
                
                anos.forEach(ano => {
                    const resultado = resultados[ano];
                    const valorAtual = aliquotasEquivalentes[ano].valor_atual;
                    const diferenca = resultado.imposto_devido - valorAtual;
                    
                    resultadosData.push([
                        ano,
                        resultado.cbs,
                        resultado.ibs,
                        resultado.imposto_bruto,
                        resultado.creditos,
                        resultado.imposto_devido,
                        valorAtual,
                        diferenca,
                        resultado.aliquota_efetiva
                    ]);
                });
                
                const wsResultados = XLSX.utils.aoa_to_sheet(resultadosData);
                XLSX.utils.book_append_sheet(wb, wsResultados, 'Resultados');
                
                // Aba de Análise Comparativa
                const comparativoData = [
                    ['Comparativo entre Carga Tributária Atual e IVA Dual'],
                    [],
                    ['Ano', 'Carga Atual (R$)', 'IVA Dual (R$)', 'Diferença (R$)', 'Variação (%)']
                ];
                
                anos.forEach(ano => {
                    const resultado = resultados[ano];
                    const valorAtual = aliquotasEquivalentes[ano].valor_atual;
                    const valorIVA = resultado.imposto_devido;
                    const diferenca = valorIVA - valorAtual;
                    const variacaoPercentual = valorAtual > 0 ? (diferenca / valorAtual) * 100 : 0;
                    
                    comparativoData.push([
                        ano,
                        valorAtual,
                        valorIVA,
                        diferenca,
                        variacaoPercentual
                    ]);
                });
                
                const wsComparativo = XLSX.utils.aoa_to_sheet(comparativoData);
                XLSX.utils.book_append_sheet(wb, wsComparativo, 'Análise Comparativa');
                
                // Salvar o arquivo
                XLSX.writeFile(wb, `simulacao-reforma-tributaria-${new Date().toISOString()}.xlsx`);
                
            } catch (error) {
                alert(`Erro ao exportar para Excel: ${error.message}`);
                console.error(error);
            }
        }
        
        // Modificar a inicialização para incluir os event listeners dos botões de exportação
        document.addEventListener('DOMContentLoaded', function() {
            // ... (manter o código de inicialização anterior)
            
            // Adicionar event listeners para exportação
            document.getElementById('btn-exportar-pdf').addEventListener('click', exportarParaPDF);
            document.getElementById('btn-exportar-excel').addEventListener('click', exportarParaExcel);
            
            // ... (manter o restante do código de inicialização)
        });
        
    // Parte 5: Finalização das Exportações
        
        function exportarParaPDF() {
            if (!window.jspdf) {
                alert('Biblioteca jsPDF não carregada. Por favor, aguarde e tente novamente.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            
            if (!resultados || Object.keys(resultados).length === 0) {
                alert('Execute uma simulação antes de exportar os resultados.');
                return;
            }
            
            try {
                // Criar documento PDF
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                let yPos = 15;
                
                // Adicionar título
                doc.setFontSize(18);
                doc.text('Relatório de Simulação - IVA Dual (CBS/IBS)', doc.internal.pageSize.width / 2, yPos, { align: 'center' });
                yPos += 10;
                
                // Data do relatório
                doc.setFontSize(10);
                const dataHora = new Date().toLocaleString('pt-BR');
                doc.text(`Data do relatório: ${dataHora}`, 15, yPos);
                yPos += 10;
                
                // Parâmetros da simulação
                doc.setFontSize(14);
                doc.text('Parâmetros da Simulação', 15, yPos);
                yPos += 8;
                
                // Dados da empresa
                const parametrosBasicos = [
                    ['Faturamento Anual', `R$ ${formatarBR(obterValorNumerico(document.getElementById('faturamento').value))}`],
                    ['Custos Tributáveis', `R$ ${formatarBR(obterValorNumerico(document.getElementById('custos').value))}`],
                    ['Fornecedores do Simples', `R$ ${formatarBR(obterValorNumerico(document.getElementById('custos_simples').value))}`],
                    ['Créditos Anteriores', `R$ ${formatarBR(obterValorNumerico(document.getElementById('creditos_anteriores').value))}`],
                    ['Setor de Atividade', document.getElementById('setor').value],
                    ['Regime Tributário', document.getElementById('regime').value],
                    ['Carga Tributária Atual', `${document.getElementById('carga_atual').value}%`],
                    ['Ano Inicial', document.getElementById('ano_inicial').value],
                    ['Ano Final', document.getElementById('ano_final').value]
                ];
                
                doc.autoTable({
                    startY: yPos,
                    head: [['Parâmetro', 'Valor']],
                    body: parametrosBasicos,
                    theme: 'grid',
                    styles: { fontSize: 10 },
                    headStyles: { fillColor: [220, 220, 220], textColor: 0 },
                    margin: { left: 15, right: 15 }
                });
                
                yPos = doc.lastAutoTable.finalY + 10;
                
                // Parâmetros de ICMS e Incentivos Fiscais
                doc.setFontSize(14);
                doc.text('Parâmetros de ICMS e Incentivos Fiscais', 15, yPos);
                yPos += 8;
                
                const parametrosICMS = [
                    ['Alíquota Média de Entrada', `${formatarBR(parseFloat(document.getElementById('aliquota_entrada').value))}%`],
                    ['Alíquota Média de Saída', `${formatarBR(parseFloat(document.getElementById('aliquota_saida').value))}%`]
                ];
                
                doc.autoTable({
                    startY: yPos,
                    head: [['Parâmetro', 'Valor']],
                    body: parametrosICMS,
                    theme: 'grid',
                    styles: { fontSize: 10 },
                    headStyles: { fillColor: [220, 220, 220], textColor: 0 },
                    margin: { left: 15, right: 15 }
                });
                
                yPos = doc.lastAutoTable.finalY + 10;
                
                // Incentivos de Saída
                const tabelaSaida = document.getElementById('tabela-incentivos-saida').querySelector('tbody');
                if (tabelaSaida && tabelaSaida.rows.length > 0) {
                    doc.setFontSize(12);
                    doc.text('Incentivos Fiscais de Saída', 15, yPos);
                    yPos += 6;
                    
                    const incentivosSaida = Array.from(tabelaSaida.rows).map(row => 
                        Array.from(row.cells).slice(0, 4).map(cell => cell.textContent)
                    );
                    
                    doc.autoTable({
                        startY: yPos,
                        head: [['Descrição', 'Tipo', 'Percentual', '% Operações']],
                        body: incentivosSaida,
                        theme: 'grid',
                        styles: { fontSize: 10 },
                        headStyles: { fillColor: [220, 220, 220], textColor: 0 },
                        margin: { left: 15, right: 15 }
                    });
                    
                    yPos = doc.lastAutoTable.finalY + 10;
                }
                
                // Incentivos de Entrada
                const tabelaEntrada = document.getElementById('tabela-incentivos-entrada').querySelector('tbody');
                if (tabelaEntrada && tabelaEntrada.rows.length > 0) {
                    doc.setFontSize(12);
                    doc.text('Incentivos Fiscais de Entrada', 15, yPos);
                    yPos += 6;
                    
                    const incentivosEntrada = Array.from(tabelaEntrada.rows).map(row => 
                        Array.from(row.cells).slice(0, 4).map(cell => cell.textContent)
                    );
                    
                    doc.autoTable({
                        startY: yPos,
                        head: [['Descrição', 'Tipo', 'Percentual', '% Operações']],
                        body: incentivosEntrada,
                        theme: 'grid',
                        styles: { fontSize: 10 },
                        headStyles: { fillColor: [220, 220, 220], textColor: 0 },
                        margin: { left: 15, right: 15 }
                    });
                    
                    yPos = doc.lastAutoTable.finalY + 10;
                }
                
                // Incentivos de Apuração
                const tabelaApuracao = document.getElementById('tabela-incentivos-apuracao').querySelector('tbody');
                if (tabelaApuracao && tabelaApuracao.rows.length > 0) {
                    doc.setFontSize(12);
                    doc.text('Incentivos Fiscais de Apuração', 15, yPos);
                    yPos += 6;
                    
                    const incentivosApuracao = Array.from(tabelaApuracao.rows).map(row => 
                        Array.from(row.cells).slice(0, 4).map(cell => cell.textContent)
                    );
                    
                    doc.autoTable({
                        startY: yPos,
                        head: [['Descrição', 'Tipo', 'Percentual', '% do Saldo']],
                        body: incentivosApuracao,
                        theme: 'grid',
                        styles: { fontSize: 10 },
                        headStyles: { fillColor: [220, 220, 220], textColor: 0 },
                        margin: { left: 15, right: 15 }
                    });
                    
                    yPos = doc.lastAutoTable.finalY + 10;
                }
                
                // Nova página para resultados
                doc.addPage();
                yPos = 15;
                
                // Resultados da simulação
                doc.setFontSize(14);
                doc.text('Resultados da Simulação', 15, yPos);
                yPos += 8;
                
                const anos = Object.keys(resultados).sort();
                const resultadosData = anos.map(ano => {
                    const resultado = resultados[ano];
                    const valorAtual = aliquotasEquivalentes[ano].valor_atual;
                    const diferenca = resultado.imposto_devido - valorAtual;
                    
                    return [
                        ano,
                        `R$ ${formatarBR(resultado.cbs)}`,
                        `R$ ${formatarBR(resultado.ibs)}`,
                        `R$ ${formatarBR(resultado.imposto_bruto)}`,
                        `R$ ${formatarBR(resultado.creditos)}`,
                        `R$ ${formatarBR(resultado.imposto_devido)}`,
                        `R$ ${formatarBR(valorAtual)}`,
                        `R$ ${formatarBR(diferenca)}`,
                        `${formatarBR(resultado.aliquota_efetiva * 100)}%`
                    ];
                });
                
                doc.autoTable({
                    startY: yPos,
                    head: [['Ano', 'CBS', 'IBS', 'Imposto Bruto', 'Créditos', 
                            'Imposto Devido', 'Carga Atual', 'Diferença', 'Alíquota Efetiva']],
                    body: resultadosData,
                    theme: 'grid',
                    styles: { fontSize: 10 },
                    headStyles: { fillColor: [52, 152, 219], textColor: 255 },
                    margin: { left: 15, right: 15 },
                    columnStyles: {
                        0: { cellWidth: 15 },
                        1: { cellWidth: 22 },
                        2: { cellWidth: 22 },
                        3: { cellWidth: 25 },
                        4: { cellWidth: 22 },
                        5: { cellWidth: 25 },
                        6: { cellWidth: 22 },
                        7: { cellWidth: 22 },
                        8: { cellWidth: 20 }
                    }
                });
                
                yPos = doc.lastAutoTable.finalY + 10;
                
                // Análise Comparativa
                doc.setFontSize(14);
                doc.text('Análise Comparativa', 15, yPos);
                yPos += 8;
                
                doc.setFontSize(10);
                const analiseTexto = `
                A análise comparativa acima demonstra o impacto da implementação do IVA Dual (CBS/IBS) em relação 
                à carga tributária atual. A coluna 'Diferença' indica a variação financeira em cada período da 
                transição tributária, sendo que valores positivos representam aumento da carga e valores negativos 
                indicam redução.
                
                É importante observar a evolução gradual da carga tributária ao longo do período de transição, 
                considerando os diversos fatores que podem influenciar o resultado final, como setor de atividade, 
                regime tributário e a estrutura de custos da empresa.
                `;
                
                const linhasAnalise = doc.splitTextToSize(analiseTexto.trim(), 180);
                doc.text(linhasAnalise, 15, yPos);
                yPos += linhasAnalise.length * 5 + 10;
                
                // Capturar gráficos como imagens
                const graficos = [
                    {
                        canvas: document.getElementById('grafico-comparativo'),
                        titulo: 'Comparativo de Impostos por Ano'
                    },
                    {
                        canvas: document.getElementById('grafico-aliquotas'),
                        titulo: 'Evolução da Alíquota Efetiva'
                    },
                    {
                        canvas: document.getElementById('grafico-transicao'),
                        titulo: 'Evolução Tributária na Transição'
                    }
                ];
                
                // Adicionar cada gráfico em uma nova página
                for (const grafico of graficos) {
                    if (grafico.canvas) {
                        doc.addPage();
                        doc.setFontSize(14);
                        doc.text(grafico.titulo, doc.internal.pageSize.width / 2, 15, { align: 'center' });
                        
                        const imgData = grafico.canvas.toDataURL('image/png');
                        const imgWidth = 180;
                        const imgHeight = 100;
                        
                        doc.addImage(imgData, 'PNG', 15, 25, imgWidth, imgHeight);
                    }
                }
                
                // Memória de Cálculo
                doc.addPage();
                yPos = 15;
                
                doc.setFontSize(14);
                doc.text('Memória de Cálculo', 15, yPos);
                yPos += 8;
                
                const memoriaTexto = document.getElementById('memoria-calculo').textContent;
                if (memoriaTexto) {
                    doc.setFontSize(8);
                    doc.setFont('courier', 'normal');
                    
                    const linhasMemoria = doc.splitTextToSize(memoriaTexto, 180);
                    let paginaAtual = doc.internal.getCurrentPageInfo().pageNumber;
                    
                    for (let i = 0; i < linhasMemoria.length; i++) {
                        if (yPos > 280) {
                            doc.addPage();
                            yPos = 15;
                        }
                        
                        doc.text(linhasMemoria[i], 15, yPos);
                        yPos += 4;
                    }
                }
                
                // Conclusão
                doc.addPage();
                yPos = 15;
                
                doc.setFontSize(14);
                doc.text('Conclusão', 15, yPos);
                yPos += 8;
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                const conclusaoTexto = `
                Este relatório apresenta uma simulação do impacto da transição para o sistema tributário IVA Dual 
                (CBS/IBS) em comparação com a carga tributária atual da empresa. As projeções consideram as 
                alíquotas específicas do setor, a fase de transição prevista na LC 214/2025 e a estrutura de 
                custos informada.
                
                Para um planejamento tributário mais preciso, recomenda-se a análise detalhada da cadeia de 
                suprimentos e a avaliação de estratégias de adaptação ao novo sistema tributário, especialmente 
                considerando as oportunidades de aproveitamento de créditos.
                `;
                
                const linhasConclusao = doc.splitTextToSize(conclusaoTexto.trim(), 180);
                doc.text(linhasConclusao, 15, yPos);
                
                // Rodapé em todas as páginas
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'italic');
                    doc.text('© 2025 Expertzy Inteligência Tributária', 
                             doc.internal.pageSize.width / 2, 
                             doc.internal.pageSize.height - 10, 
                             { align: 'center' });
                }
                
                // Salvar o arquivo
                doc.save(`simulacao-reforma-tributaria-${new Date().toISOString().slice(0, 10)}.pdf`);
                
            } catch (error) {
                alert(`Erro ao exportar para PDF: ${error.message}`);
                console.error(error);
            }
        }
        
        function exportarParaExcel() {
            if (!XLSX) {
                alert('Biblioteca XLSX não carregada. Por favor, aguarde e tente novamente.');
                return;
            }
            
            if (!resultados || Object.keys(resultados).length === 0) {
                alert('Execute uma simulação antes de exportar os resultados.');
                return;
            }
            
            try {
                // Criar workbook
                const wb = XLSX.utils.book_new();
                
                // Aba de Parâmetros
                const parametros = [
                        ['Simulador da Reforma Tributária - IVA Dual (CBS/IBS)'],
                        ['Data do relatório', new Date().toLocaleString('pt-BR')],
                        [],
                        ['Parâmetro', 'Valor'],
                        ['Faturamento Anual', `R$ ${formatarBR(obterValorNumerico(document.getElementById('faturamento')))}`],
                        ['Custos Tributáveis (PIS/COFINS/IVA/CBS)', `R$ ${formatarBR(obterValorNumerico(document.getElementById('custos')))}`],
                        ['Custos Tributáveis (ICMS)', `R$ ${formatarBR(obterValorNumerico(document.getElementById('custos_icms')))}`],
                        ['Fornecedores do Simples', `R$ ${formatarBR(obterValorNumerico(document.getElementById('custos_simples')))}`],
                        ['Créditos Anteriores', `R$ ${formatarBR(obterValorNumerico(document.getElementById('creditos_anteriores')))}`],
                        ['Setor de Atividade', document.getElementById('setor').value],
                        ['Regime Tributário', document.getElementById('regime').value],
                        ['Carga Tributária Atual', `${document.getElementById('carga_atual').value}%`],
                        ['Ano Inicial', document.getElementById('ano_inicial').value],
                        ['Ano Final', document.getElementById('ano_final').value]
                ];
                
                const wsParametros = XLSX.utils.aoa_to_sheet(parametros);
                
                // Aplicar estilos básicos
                wsParametros['A1'].s = { font: { bold: true, sz: 14 } };
                wsParametros['A4'].s = { font: { bold: true }, fill: { fgColor: { rgb: 'DDDDDD' } } };
                wsParametros['B4'].s = { font: { bold: true }, fill: { fgColor: { rgb: 'DDDDDD' } } };
                
                // Definir largura das colunas
                wsParametros['!cols'] = [{ wch: 25 }, { wch: 25 }];
                
                XLSX.utils.book_append_sheet(wb, wsParametros, 'Parâmetros');
                
                // Aba de Resultados
                const anos = Object.keys(resultados).sort();
                const resultadosData = [
                    ['Resultados da Simulação'],
                    [],
                    ['Ano', 'CBS (R$)', 'IBS (R$)', 'Imposto Bruto (R$)', 'Créditos (R$)', 
                     'Imposto Devido (R$)', 'Carga Atual (R$)', 'Diferença (R$)', 'Alíquota Efetiva (%)']
                ];
                
                anos.forEach(ano => {
                    const resultado = resultados[ano];
                    const valorAtual = aliquotasEquivalentes[ano].valor_atual;
                    const diferenca = resultado.imposto_devido - valorAtual;
                    
                    resultadosData.push([
                        ano,
                        resultado.cbs,
                        resultado.ibs,
                        resultado.imposto_bruto,
                        resultado.creditos,
                        resultado.imposto_devido,
                        valorAtual,
                        diferenca,
                        resultado.aliquota_efetiva
                    ]);
                });
                
                const wsResultados = XLSX.utils.aoa_to_sheet(resultadosData);
                
                // Definir formatação de moeda e porcentagem
                const range = XLSX.utils.decode_range(wsResultados['!ref']);
                for (let R = 3; R <= range.e.r; ++R) {
                    for (let C = 1; C <= 7; ++C) {
                        const cell_address = XLSX.utils.encode_cell({ r: R, c: C });
                        if (wsResultados[cell_address]) {
                            wsResultados[cell_address].z = '#,##0.00';
                        }
                    }
                    // Formatar coluna de alíquota efetiva como porcentagem
                    const cell_address = XLSX.utils.encode_cell({ r: R, c: 8 });
                    if (wsResultados[cell_address]) {
                        wsResultados[cell_address].z = '0.00%';
                    }
                }
                
                XLSX.utils.book_append_sheet(wb, wsResultados, 'Resultados');
                
                // Aba de Análise Comparativa
                const comparativoData = [
                    ['Comparativo entre Carga Tributária Atual e IVA Dual'],
                    [],
                    ['Ano', 'Carga Atual (R$)', 'IVA Dual (R$)', 'Diferença (R$)', 'Variação (%)']
                ];
                
                anos.forEach(ano => {
                    const resultado = resultados[ano];
                    const valorAtual = aliquotasEquivalentes[ano].valor_atual;
                    const valorIVA = resultado.imposto_devido;
                    const diferenca = valorIVA - valorAtual;
                    const variacaoPercentual = valorAtual > 0 ? (diferenca / valorAtual) * 100 : 0;
                    
                    comparativoData.push([
                        ano,
                        valorAtual,
                        valorIVA,
                        diferenca,
                        variacaoPercentual / 100
                    ]);
                });
                
                const wsComparativo = XLSX.utils.aoa_to_sheet(comparativoData);
                
                // Formatar coluna de variação como porcentagem
                const rangeComp = XLSX.utils.decode_range(wsComparativo['!ref']);
                for (let R = 3; R <= rangeComp.e.r; ++R) {
                    const cell_address = XLSX.utils.encode_cell({ r: R, c: 4 });
                    if (wsComparativo[cell_address]) {
                        wsComparativo[cell_address].z = '0.00%';
                    }
                }
                
                XLSX.utils.book_append_sheet(wb, wsComparativo, 'Análise Comparativa');
                
                // Aba de Incentivos Fiscais
                if (configuracao.icms_config.incentivos_saida.length > 0 || 
                    configuracao.icms_config.incentivos_entrada.length > 0 ||
                    configuracao.icms_config.incentivos_apuracao.length > 0) {
                    
                    const incentivosData = [
                        ['Incentivos Fiscais - ICMS'],
                        [],
                        ['Parâmetros Básicos de ICMS'],
                        ['Alíquota Média de Entrada', `${formatarBR(parseFloat(document.getElementById('aliquota_entrada').value))}%`],
                        ['Alíquota Média de Saída', `${formatarBR(parseFloat(document.getElementById('aliquota_saida').value))}%`],
                        [],
                        ['Incentivos Fiscais de Saída'],
                        ['Descrição', 'Tipo', 'Percentual', '% Operações']
                    ];
                    
                    // Incentivos de saída
                    configuracao.icms_config.incentivos_saida.forEach(incentivo => {
                        incentivosData.push([
                            incentivo.descricao,
                            incentivo.tipo,
                            `${formatarBR(incentivo.percentual * 100)}%`,
                            `${formatarBR(incentivo.percentual_operacoes * 100)}%`
                        ]);
                    });
                    
                    incentivosData.push([], ['Incentivos Fiscais de Entrada']);
                    incentivosData.push(['Descrição', 'Tipo', 'Percentual', '% Operações']);
                    
                    // Incentivos de entrada
                    configuracao.icms_config.incentivos_entrada.forEach(incentivo => {
                        incentivosData.push([
                            incentivo.descricao,
                            incentivo.tipo,
                            `${formatarBR(incentivo.percentual * 100)}%`,
                            `${formatarBR(incentivo.percentual_operacoes * 100)}%`
                        ]);
                    });
                    
                    incentivosData.push([], ['Incentivos Fiscais de Apuração']);
                    incentivosData.push(['Descrição', 'Tipo', 'Percentual', '% do Saldo']);
                    
                    // Incentivos de apuração
                    configuracao.icms_config.incentivos_apuracao.forEach(incentivo => {
                        incentivosData.push([
                            incentivo.descricao,
                            incentivo.tipo,
                            `${formatarBR(incentivo.percentual * 100)}%`,
                            `${formatarBR(incentivo.percentual_operacoes * 100)}%`
                        ]);
                    });
                    
                    const wsIncentivos = XLSX.utils.aoa_to_sheet(incentivosData);
                    XLSX.utils.book_append_sheet(wb, wsIncentivos, 'Incentivos Fiscais');
                }
                
                // Aba de Memória de Cálculo
                const memoriaTexto = document.getElementById('memoria-calculo').textContent;
                if (memoriaTexto) {
                    const linhasMemoria = memoriaTexto.split('\n');
                    const memoriaData = [['Memória de Cálculo']];
                    
                    linhasMemoria.forEach(linha => {
                        memoriaData.push([linha]);
                    });
                    
                    const wsMemoria = XLSX.utils.aoa_to_sheet(memoriaData);
                    wsMemoria['!cols'] = [{ wch: 100 }];
                    
                    XLSX.utils.book_append_sheet(wb, wsMemoria, 'Memória de Cálculo');
                }
                
                // Aba de Alíquotas Setoriais
                const setoriaisData = [
                    ['Alíquotas por Setor - LC 214/2025'],
                    [],
                    ['Setor', 'IBS (%)', 'Redução CBS (%)']
                ];
                
                for (const [setor, valores] of Object.entries(configuracao.setores_especiais)) {
                    setoriaisData.push([
                        setor,
                        valores.IBS,
                        valores.reducao_CBS
                    ]);
                }
                
                const wsSetoriais = XLSX.utils.aoa_to_sheet(setoriaisData);
                
                // Formatar como porcentagem
                const rangeSetoriais = XLSX.utils.decode_range(wsSetoriais['!ref']);
                for (let R = 3; R <= rangeSetoriais.e.r; ++R) {
                    for (let C = 1; C <= 2; ++C) {
                        const cell_address = XLSX.utils.encode_cell({ r: R, c: C });
                        if (wsSetoriais[cell_address]) {
                            wsSetoriais[cell_address].z = '0.00%';
                        }
                    }
                }
                
                XLSX.utils.book_append_sheet(wb, wsSetoriais, 'Alíquotas Setoriais');
                
                // Aba de Fases de Transição
                const fasesData = [
                    ['Fases de Transição - LC 214/2025'],
                    [],
                    ['Ano', 'Percentual de Implementação']
                ];
                
                for (const [ano, percentual] of Object.entries(configuracao.fase_transicao)) {
                    fasesData.push([ano, percentual]);
                }
                
                const wsFases = XLSX.utils.aoa_to_sheet(fasesData);
                
                // Formatar como porcentagem
                const rangeFases = XLSX.utils.decode_range(wsFases['!ref']);
                for (let R = 3; R <= rangeFases.e.r; ++R) {
                    const cell_address = XLSX.utils.encode_cell({ r: R, c: 1 });
                    if (wsFases[cell_address]) {
                        wsFases[cell_address].z = '0.00%';
                    }
                }
                
                XLSX.utils.book_append_sheet(wb, wsFases, 'Fases de Transição');
                
                // Aba de Alíquotas Equivalentes
                const equivalentesData = [
                    ['Alíquotas Equivalentes à Carga Tributária Atual'],
                    [],
                    ['Ano', 'CBS Equivalente (%)', 'IBS Equivalente (%)', 'Total Equivalente (%)']
                ];
                
                for (const [ano, dados] of Object.entries(aliquotasEquivalentes)) {
                    equivalentesData.push([
                        ano,
                        dados.cbs_equivalente,
                        dados.ibs_equivalente,
                        dados.total_equivalente
                    ]);
                }
                
                const wsEquivalentes = XLSX.utils.aoa_to_sheet(equivalentesData);
                
                // Formatar como porcentagem
                const rangeEquiv = XLSX.utils.decode_range(wsEquivalentes['!ref']);
                for (let R = 3; R <= rangeEquiv.e.r; ++R) {
                    for (let C = 1; C <= 3; ++C) {
                        const cell_address = XLSX.utils.encode_cell({ r: R, c: C });
                        if (wsEquivalentes[cell_address]) {
                            wsEquivalentes[cell_address].z = '0.00%';
                        }
                    }
                }
                
                XLSX.utils.book_append_sheet(wb, wsEquivalentes, 'Alíquotas Equivalentes');
                
                // Salvar o arquivo
                XLSX.writeFile(wb, `simulacao-reforma-tributaria-${new Date().toISOString().slice(0, 10)}.xlsx`);
                
            } catch (error) {
                alert(`Erro ao exportar para Excel: ${error.message}`);
                console.error(error);
            }
        }
        
        // Função auxiliar para converter imagem canvas para base64
        function canvasParaBase64(canvas) {
            if (!canvas) return null;
            return canvas.toDataURL('image/png');
        }
        
        // Função para ajustar largura de colunas no Excel
        function ajustarColunasExcel(worksheet, colunas) {
            worksheet['!cols'] = colunas.map(largura => ({ wch: largura }));
            return worksheet;
        }
        
        // Função para aplicar estilos de célula no Excel
        function aplicarEstilosCelula(celula, estilos) {
            if (!celula) return;
            
            const estiloPadrao = {
                font: {
                    name: 'Arial',
                    sz: 10,
                    color: { rgb: '000000' }
                },
                fill: {
                    fgColor: { rgb: 'FFFFFF' }
                },
                border: {
                    top: { style: 'thin', color: { rgb: '000000' } },
                    bottom: { style: 'thin', color: { rgb: '000000' } },
                    left: { style: 'thin', color: { rgb: '000000' } },
                    right: { style: 'thin', color: { rgb: '000000' } }
                },
                alignment: {
                    horizontal: 'left',
                    vertical: 'center'
                }
            };
            
            celula.s = Object.assign({}, estiloPadrao, estilos);
        }
        
        // Função para formatar data no formato DD/MM/YYYY HH:mm:ss
        function formatarDataHora(data) {
            return data.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
        
        // Função para validar dados antes da exportação
        function validarDadosExportacao() {
            if (!resultados || Object.keys(resultados).length === 0) {
                return 'Execute uma simulação antes de exportar os resultados.';
            }
            
            if (!configuracao) {
                return 'As configurações não foram carregadas corretamente.';
            }
            
            return null;
        }
        
        // Finalização da inicialização
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar classes
            configuracao = new ConfiguracaoTributaria();
            calculadora = new CalculadoraIVADual(configuracao);
            
            // Inicializar abas
            inicializarAbas();
            inicializarAbasIncentivos();
            
            // Adicionar event listeners para botões
            document.getElementById('btn-simular').addEventListener('click', executarSimulacao);
            document.getElementById('btn-atualizar-memoria').addEventListener('click', atualizarMemoriaCalculo);
            document.getElementById('btn-salvar-config').addEventListener('click', salvarConfiguracoes);
            document.getElementById('btn-carregar-config').addEventListener('click', carregarConfiguracoes);
            document.getElementById('btn-restaurar-config').addEventListener('click', restaurarConfiguracoes);
            
            // Event listeners para exportação
            document.getElementById('btn-exportar-pdf').addEventListener('click', exportarParaPDF);
            document.getElementById('btn-exportar-excel').addEventListener('click', exportarParaExcel);
            document.getElementById('btn-exportar-memoria').addEventListener('click', function() {
                const texto = document.getElementById('memoria-calculo').textContent;
                if (!texto) {
                    alert('Não há memória de cálculo para exportar. Execute uma simulação primeiro.');
                    return;
                }
                
                const blob = new Blob([texto], { type: 'text/plain;charset=utf-8' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `memoria-calculo-${new Date().toISOString().slice(0, 10)}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            });
            
            // Adicionar máscara de moeda nos campos de valor
            function formatarMoeda(input) {
                let valor = input.value.replace(/\D/g, '');
                
                if (!valor) {
                    input.value = 'R$ 0,00';
                    return;
                }
                
                const valorNumerico = parseFloat(valor) / 100;
                input.value = 'R$ ' + formatarBR(valorNumerico);
            }
            
            const camposMoeda = [
                'faturamento',
                'custos',
                'custos_icms',
                'custos_simples',
                'creditos_anteriores'
            ];
            
            camposMoeda.forEach(campoId => {
                const campo = document.getElementById(campoId);
                if (campo) {
                    campo.addEventListener('keyup', function() {
                        formatarMoeda(this);
                    });
                }
            });
            
            // Carregar configurações se existirem
            const configSalva = localStorage.getItem('configuracao_tributaria');
            if (configSalva) {
                configuracao.carregarConfiguracoes(JSON.parse(configSalva));
            }
            
            // Validar entrada de números negativos
            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('change', function() {
                    if (this.value < 0) {
                        this.value = 0;
                        alert('Valores negativos não são permitidos.');
                    }
                });
            });
            
            // Handler para o campo de regime tributário
            document.getElementById('regime').addEventListener('change', function() {
                const faturamentoInput = document.getElementById('faturamento');
                const limiteSimples = configuracao.limite_simples;
                
                if (this.value === 'simples' && parseFloat(faturamentoInput.value) > limiteSimples) {
                    alert(`Empresas do Simples Nacional devem ter faturamento anual até R$ ${formatarBR(limiteSimples)}`);
                    this.value = 'real';
                }
            });
            
            // Handler para o campo de faturamento quando Simples selecionado
            document.getElementById('faturamento').addEventListener('change', function() {
                const regime = document.getElementById('regime').value;
                const limiteSimples = configuracao.limite_simples;
                
                if (regime === 'simples' && parseFloat(this.value) > limiteSimples) {
                    alert(`Empresas do Simples Nacional devem ter faturamento anual até R$ ${formatarBR(limiteSimples)}`);
                    this.value = limiteSimples;
                }
            });
            
            // Adicionar dicas aos campos
            const dicas = {
                'faturamento': 'Informe o faturamento anual da empresa',
                'custos': 'Informe o total de custos tributáveis (que geram crédito fiscal)',
                'custos_simples': 'Informe o total de custos com fornecedores do Simples Nacional',
                'creditos_anteriores': 'Informe o saldo de créditos fiscais acumulados',
                'setor': 'Selecione o setor de atividade principal da empresa',
                'regime': 'Selecione o regime tributário atual da empresa',
                'carga_atual': 'Informe a carga tributária atual estimada',
                'aliquota_entrada': 'Informe a alíquota média de ICMS nas compras',
                'aliquota_saida': 'Informe a alíquota média de ICMS nas vendas'
            };
            
            for (const [id, dica] of Object.entries(dicas)) {
                const elemento = document.getElementById(id);
                if (elemento) {
                    elemento.title = dica;
                }
            }
            
            console.log("Parte 5: Exportações completas e aplicação inicializada com sucesso!");
        });
    </script>
</body>
</html>
